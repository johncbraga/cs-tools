<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pro Analyses</title>

  <!-- SheetJS (XLSX reader) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg: #0b1020;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --accent: #7c5cff;
      --accent2:#23d5ab;
      --danger:#ff4d6d;
      --ok:#2ee59d;
      --warn:#ffcc66;

      --radius: 16px;
      --shadow: 0 14px 45px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(124,92,255,.35), transparent 50%),
        radial-gradient(900px 500px at 80% 20%, rgba(35,213,171,.25), transparent 45%),
        radial-gradient(900px 700px at 40% 100%, rgba(255,77,109,.16), transparent 55%),
        var(--bg);
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 18px 22px;
      backdrop-filter: blur(12px);
      background: rgba(11,16,32,.65);
      border-bottom: 1px solid var(--stroke);
    }

    .brand{ display:flex; gap:14px; align-items:center; }
    .logo{
      width:44px; height:44px;
      border-radius:14px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 28px rgba(124,92,255,.25);
      font-weight:800;
      letter-spacing:.3px;
      user-select:none;
    }
    .title{ margin:0; font-size: 18px; line-height: 1.1; }
    .subtitle{ margin:3px 0 0; color: var(--muted); font-size: 12.5px; }

    .top-actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .container{
      max-width: 1180px;
      margin: 0 auto;
      padding: 18px 18px 36px;
    }

    .panel{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-top: 16px;
      overflow: hidden;
    }

    .panel-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 16px 16px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }

    .panel-head h2{
      margin:0;
      font-size: 15px;
      letter-spacing:.2px;
      color: rgba(255,255,255,.88);
    }

    .stats{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 12px;
      padding: 14px 16px 18px;
    }
    .stat{
      background: var(--card2);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 14px 14px 12px;
      min-height: 76px;
    }
    .stat-label{ color: var(--muted); font-size: 12px; }
    .stat-value{ font-size: 20px; margin-top: 6px; font-weight: 750; }

    .grid-2{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 12px;
      padding: 14px 16px 18px;
    }
    .grid-1{
      padding: 0 16px 18px;
    }

    .filters{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:end;
      justify-content:flex-end;
    }

    .field{ display:flex; flex-direction:column; gap:6px; }
    label{ font-size: 11.5px; color: var(--muted); }
    input, select{
      width: 220px;
      padding: 10px 11px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
    }
    input::placeholder{ color: rgba(255,255,255,.40); }
    input:focus, select:focus{
      border-color: rgba(124,92,255,.70);
      box-shadow: 0 0 0 4px rgba(124,92,255,.16);
    }

    .btn{
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight:650;
      text-decoration:none;
      color: var(--text);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;
      background: rgba(255,255,255,.05);
    }
    .btn:hover{ background: rgba(255,255,255,.08); }

    .btn-primary{
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(35,213,171,.85));
      border-color: rgba(255,255,255,.0);
    }
    .btn-primary:hover{ filter: brightness(1.06); }

    .table-wrap{ overflow:auto; }
    .table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 920px;
    }
    thead th{
      text-align:left;
      font-size: 12px;
      color: rgba(255,255,255,.78);
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.15);
      position: sticky;
      top: 0;
      backdrop-filter: blur(8px);
    }
    tbody td{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-size: 13px;
      color: rgba(255,255,255,.90);
      vertical-align: middle;
    }
    tbody tr:hover td{ background: rgba(255,255,255,.03); }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      white-space: nowrap;
    }
    .badge.ok{ border-color: rgba(46,229,157,.25); background: rgba(46,229,157,.12); }
    .badge.danger{ border-color: rgba(255,77,109,.25); background: rgba(255,77,109,.12); }
    .badge.neutral{ border-color: rgba(255,255,255,.14); background: rgba(255,255,255,.06); }
    .badge.warn{ border-color: rgba(255,204,102,.25); background: rgba(255,204,102,.12); }

    .pill{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.82);
      white-space: nowrap;
    }
    .pill-good{ border-color: rgba(46,229,157,.25); background: rgba(46,229,157,.12); }
    .pill-bad{ border-color: rgba(255,77,109,.25); background: rgba(255,77,109,.12); }
    .pill-neutral{ border-color: rgba(255,255,255,.14); background: rgba(255,255,255,.06); }
    .pill-warn{ border-color: rgba(255,204,102,.25); background: rgba(255,204,102,.12); }

    .hint{
      padding: 12px 16px 16px;
      color: var(--muted);
      font-size: 12px;
    }

    kbd{
      font-family: var(--mono);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.85);
    }

    .footer{
      color: var(--muted);
      font-size: 12px;
      padding: 12px 6px 0;
      text-align:right;
    }

    .errorBox{
      margin: 10px 16px 16px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,77,109,.25);
      background: rgba(255,77,109,.10);
      color: rgba(255,255,255,.88);
      line-height: 1.35;
      display:none;
    }

    .small{
      font-size: 12px;
      color: rgba(255,255,255,.80);
    }

    .chartCard{
      background: var(--card2);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 14px;
      min-height: 320px;
    }

    .chartTop{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .chartTitle{
      margin:0;
      font-size: 13px;
      color: rgba(255,255,255,.88);
      letter-spacing:.2px;
    }

    .chartMeta{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .metaBox{
      padding: 7px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      font-size: 12px;
      color: rgba(255,255,255,.86);
      white-space: nowrap;
    }

    .canvasWrap{
      width: 100%;
      height: 240px;
    }
    .canvasWrap.tall{
      height: 320px;
    }

    .canvasWrap canvas{
      width: 100% !important;
      height: 100% !important;
    }

    /* Last 5 matches list */
    .last5{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 6px;
    }
    .matchItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .matchLeft{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width: 0;
    }
    .matchLine1{
      display:flex;
      align-items:center;
      gap: 8px;
      min-width: 0;
      flex-wrap: wrap;
    }
    .matchVs{
      font-weight: 750;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 280px;
    }
    .matchLine2{
      color: rgba(255,255,255,.72);
      font-size: 12px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .matchRight{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content:flex-end;
      text-align:right;
      white-space: nowrap;
    }

    @media (max-width: 1020px){
      .stats{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .grid-2{ grid-template-columns: 1fr; }
      input, select{ width: 190px; }
      .matchVs{ max-width: 220px; }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">PA</div>
      <div>
        <h1 class="title">Pro Analyses</h1>
        <p class="subtitle">Excel-driven match analytics • winner detection + team stats</p>
      </div>
    </div>

    <div class="top-actions">
      <button id="updateBtn" class="btn btn-primary" type="button" title="Force reload the Excel file">
        Update
      </button>

      <a class="btn" href="index.html">Back to Menu</a>
    </div>
  </header>

  <main class="container">

    <!-- Dashboard -->
    <section class="panel">
      <div class="panel-head">
        <h2>Dashboard</h2>
        <span id="statusPill" class="pill pill-neutral">Loading…</span>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="stat-label">Total Matches</div>
          <div class="stat-value" id="totalMatches">—</div>
        </div>
        <div class="stat">
          <div class="stat-label">Team 1 Wins</div>
          <div class="stat-value" id="team1Wins">—</div>
        </div>
        <div class="stat">
          <div class="stat-label">Team 2 Wins</div>
          <div class="stat-value" id="team2Wins">—</div>
        </div>
        <div class="stat">
          <div class="stat-label">Most Played Map</div>
          <div class="stat-value" id="topMap">—</div>
        </div>
      </div>

      <div id="errorBox" class="errorBox"></div>
    </section>

    <!-- Team charts -->
    <section class="panel">
      <div class="panel-head">
        <h2>Team Performance</h2>

        <div class="filters">
          <div class="field">
            <label for="teamSelect">Team</label>
            <select id="teamSelect">
              <option value="">Select a team</option>
            </select>
          </div>

          <div class="field">
            <label for="teamMapSelect">Map</label>
            <select id="teamMapSelect" disabled>
              <option value="__general__">General (all maps)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Chart 1 + Last 5 -->
      <div class="grid-2">
        <div class="chartCard">
          <div class="chartTop">
            <h3 class="chartTitle">Wins vs Losses</h3>
            <div class="chartMeta">
              <div class="metaBox">Total: <b id="totalBox">—</b></div>
              <div class="metaBox">Wins: <b id="winsBox">—</b></div>
              <div class="metaBox">Losses: <b id="lossesBox">—</b></div>
              <div class="metaBox">Win rate: <b id="rateBox">—</b></div>
            </div>
          </div>

          <div class="canvasWrap">
            <canvas id="wlChart" aria-label="Wins and losses chart"></canvas>
          </div>

          <div class="hint">
            Pick a map (or <b>General</b>) to see wins, losses and win rate.
          </div>
        </div>

        <div class="chartCard">
          <div class="chartTop">
            <h3 class="chartTitle">Last 5 Matches</h3>
            <div class="chartMeta">
              <div class="metaBox">Based on the latest rows in the Excel file</div>
            </div>
          </div>

          <div id="last5List" class="last5">
            <div class="matchItem">
              <div class="matchLeft">
                <div class="matchLine1">
                  <span class="badge neutral">Select a team</span>
                  <span class="matchVs">to display matches</span>
                </div>
                <div class="matchLine2">
                  <span class="badge neutral">—</span>
                  <span class="badge neutral">—</span>
                </div>
              </div>
              <div class="matchRight">
                <span class="badge neutral">—</span>
              </div>
            </div>
          </div>

          <div class="hint" style="padding-top:10px;">
            Tip: Press <kbd>0</kbd> to go back (only when not typing in a field).
          </div>
        </div>
      </div>

      <!-- Chart 2: General overview -->
      <div class="grid-1">
        <div class="chartCard" style="min-height: 380px;">
          <div class="chartTop">
            <h3 class="chartTitle">General Overview (Best/Worst map + Maps played)</h3>
            <div class="chartMeta">
              <div class="metaBox">Best map: <b id="bestMapBox">—</b> <span id="bestMapMeta"></span></div>
              <div class="metaBox">Worst map: <b id="worstMapBox">—</b> <span id="worstMapMeta"></span></div>
            </div>
          </div>

          <div class="canvasWrap tall">
            <canvas id="mapPlayChart" aria-label="Maps played chart"></canvas>
          </div>

          <div class="hint">
            Maps are shown in <b>ascending order</b> by number of matches played for the selected team.
          </div>
        </div>
      </div>
    </section>

    <!-- Match list -->
    <section class="panel">
      <div class="panel-head">
        <h2>Matches</h2>
        <div class="filters">
          <div class="field">
            <label for="searchInput">Search</label>
            <input id="searchInput" type="text" placeholder="Team name…" autocomplete="off" />
          </div>

          <div class="field">
            <label for="mapSelect">Map</label>
            <select id="mapSelect">
              <option value="">All maps</option>
            </select>
          </div>

          <div class="field">
            <label for="winnerSelect">Winner side</label>
            <select id="winnerSelect">
              <option value="">Any</option>
              <option value="Team 1">Team 1</option>
              <option value="Team 2">Team 2</option>
            </select>
          </div>

          <button id="clearBtn" class="btn btn-primary" type="button">Clear</button>
        </div>
      </div>

      <div class="table-wrap">
        <table class="table" aria-label="Match list">
          <thead>
            <tr>
              <th>#</th>
              <th>Team 1</th>
              <th>Team 2</th>
              <th>Map</th>
              <th>Result</th>
              <th>Winner</th>
            </tr>
          </thead>
          <tbody id="matchesTbody">
            <tr>
              <td colspan="6"><span class="badge neutral">Loading</span> Reading Excel…</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="hint">
        Tip: Press <kbd>0</kbd> to go back (works only when you are not typing in a field).
      </div>
    </section>

    <footer class="footer">
      <span id="sourceInfo">Source: file/history.xlsx</span>
    </footer>
  </main>

  <script>
    /*
      Pro Analyses (single-file)
      Excel file: file/history.xlsx
      Winner logic: Result = "Team 1 score x Team 2 score" (position matters)
      Features:
        - Update button forces Excel reload (cache bust)
        - Team W/L chart with map selector (General = all maps)
        - Last 5 matches for selected team
        - General overview: best/worst map + maps played (ascending by matches)
        - Filters + table
        - Shortcut key "0" to go back (not when typing)
    */

    const EXCEL_PATH = "file/history.xlsx";
    const EXPECTED_HEADERS = ["Team 1", "Team 2", "Map", "Result"];
    const GENERAL_MAP_VALUE = "__general__";

    const els = {
      statusPill: document.getElementById("statusPill"),
      totalMatches: document.getElementById("totalMatches"),
      team1Wins: document.getElementById("team1Wins"),
      team2Wins: document.getElementById("team2Wins"),
      topMap: document.getElementById("topMap"),
      tbody: document.getElementById("matchesTbody"),
      search: document.getElementById("searchInput"),
      mapSelect: document.getElementById("mapSelect"),
      winnerSelect: document.getElementById("winnerSelect"),
      clearBtn: document.getElementById("clearBtn"),
      sourceInfo: document.getElementById("sourceInfo"),
      errorBox: document.getElementById("errorBox"),
      updateBtn: document.getElementById("updateBtn"),

      // chart UI
      teamSelect: document.getElementById("teamSelect"),
      teamMapSelect: document.getElementById("teamMapSelect"),
      totalBox: document.getElementById("totalBox"),
      winsBox: document.getElementById("winsBox"),
      lossesBox: document.getElementById("lossesBox"),
      rateBox: document.getElementById("rateBox"),
      wlCanvas: document.getElementById("wlChart"),

      last5List: document.getElementById("last5List"),

      bestMapBox: document.getElementById("bestMapBox"),
      worstMapBox: document.getElementById("worstMapBox"),
      bestMapMeta: document.getElementById("bestMapMeta"),
      worstMapMeta: document.getElementById("worstMapMeta"),
      mapPlayCanvas: document.getElementById("mapPlayChart")
    };

    let allMatches = [];
    let wlChart = null;
    let mapPlayChart = null;

    init();

    async function init(){
      els.sourceInfo.textContent = `Source: ${EXCEL_PATH}`;
      setupShortcutBack();
      setupFilters();
      setupUpdateButton();
      setupTeamControls();
      buildCharts();

      await reloadExcel(true);
    }

    function setupUpdateButton(){
      els.updateBtn.addEventListener("click", async () => {
        await reloadExcel(true);
      });
    }

    async function reloadExcel(force){
      try{
        setStatus(force ? "Updating… (forcing reload)" : "Loading Excel…", force ? "warn" : "neutral");
        disableUpdate(true);

        const matches = await loadExcelMatches(EXCEL_PATH, force);
        allMatches = matches;

        populateMapOptions(allMatches);
        populateTeamOptions(allMatches);

        // apply filters on match table
        applyMatchFilters();

        // update dashboard based on current filters
        renderStats(getFilteredMatchesFromControls());

        // keep selections and update team sections
        reconcileTeamSelectionsAfterReload();
        updateTeamSections();

        setStatus(`Loaded ${allMatches.length} matches`, "good");
        hideError();
      }catch(err){
        console.error(err);
        setStatus("Failed to load Excel", "bad");
        showError(
          `Could not load <b>${EXCEL_PATH}</b>.<br><span class="small">
           Make sure the file exists in <code>file/</code> and run this page using a local web server
           (e.g., VS Code Live Server). Browsers often block <code>fetch</code> from local files when opened by double-click.
           </span>`
        );

        els.tbody.innerHTML = `
          <tr>
            <td colspan="6">
              <span class="badge danger">Error</span>
              Could not load <b>${escapeHtml(EXCEL_PATH)}</b>.
            </td>
          </tr>
        `;
      } finally{
        disableUpdate(false);
      }
    }

    function disableUpdate(disabled){
      els.updateBtn.disabled = disabled;
      els.updateBtn.style.opacity = disabled ? "0.75" : "1";
      els.updateBtn.style.cursor = disabled ? "not-allowed" : "pointer";
    }

    function setStatus(text, state){
      els.statusPill.textContent = text;
      els.statusPill.className =
        "pill " + (state === "good" ? "pill-good" : state === "bad" ? "pill-bad" : state === "warn" ? "pill-warn" : "pill-neutral");
    }

    function showError(html){
      els.errorBox.style.display = "block";
      els.errorBox.innerHTML = html;
    }

    function hideError(){
      els.errorBox.style.display = "none";
      els.errorBox.innerHTML = "";
    }

    function setupShortcutBack(){
      document.addEventListener("keydown", (e) => {
        if (e.key !== "0") return;

        const a = document.activeElement;
        const isTypingContext =
          a && (
            a.tagName === "INPUT" ||
            a.tagName === "TEXTAREA" ||
            a.tagName === "SELECT" ||
            a.isContentEditable
          );

        if (isTypingContext) return;

        e.preventDefault();
        window.history.back();
      });
    }

    /* -----------------------------
       Match table filters
    ------------------------------*/
    function setupFilters(){
      els.search.addEventListener("input", () => {
        applyMatchFilters();
        renderStats(getFilteredMatchesFromControls());
      });
      els.mapSelect.addEventListener("change", () => {
        applyMatchFilters();
        renderStats(getFilteredMatchesFromControls());
      });
      els.winnerSelect.addEventListener("change", () => {
        applyMatchFilters();
        renderStats(getFilteredMatchesFromControls());
      });

      els.clearBtn.addEventListener("click", () => {
        els.search.value = "";
        els.mapSelect.value = "";
        els.winnerSelect.value = "";
        render(allMatches);
        renderStats(allMatches);
      });
    }

    function getFilteredMatchesFromControls(){
      const q = (els.search.value || "").trim().toLowerCase();
      const map = els.mapSelect.value;
      const winnerSide = els.winnerSelect.value;

      return allMatches.filter(m => {
        const matchesQuery =
          !q ||
          m.team1.toLowerCase().includes(q) ||
          m.team2.toLowerCase().includes(q);

        const matchesMap = !map || m.map === map;
        const matchesWinner = !winnerSide || m.winnerSide === winnerSide;

        return matchesQuery && matchesMap && matchesWinner;
      });
    }

    function applyMatchFilters(){
      const filtered = getFilteredMatchesFromControls();
      render(filtered);
    }

    function populateMapOptions(matches){
      while (els.mapSelect.options.length > 1) els.mapSelect.remove(1);
      const maps = [...new Set(matches.map(m => m.map))].sort((a,b) => a.localeCompare(b));
      for (const m of maps){
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        els.mapSelect.appendChild(opt);
      }
    }

    function render(matches){
      els.tbody.innerHTML = "";

      if (!matches.length){
        els.tbody.innerHTML = `
          <tr>
            <td colspan="6">
              <span class="badge neutral">No results</span>
              Try clearing filters.
            </td>
          </tr>`;
        return;
      }

      matches.forEach((m, idx) => {
        const winnerBadgeClass = m.winnerSide === "Team 1" ? "ok" : "danger";
        const winnerText = `${m.winner} (${m.winnerSide})`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${escapeHtml(m.team1)}</td>
          <td>${escapeHtml(m.team2)}</td>
          <td>${escapeHtml(m.map)}</td>
          <td><span class="badge neutral">${m.score1}x${m.score2}</span></td>
          <td><span class="badge ${winnerBadgeClass}">${escapeHtml(winnerText)}</span></td>
        `;
        els.tbody.appendChild(tr);
      });
    }

    function renderStats(matches){
      els.totalMatches.textContent = matches.length.toString();

      const t1 = matches.filter(m => m.winnerSide === "Team 1").length;
      const t2 = matches.filter(m => m.winnerSide === "Team 2").length;

      els.team1Wins.textContent = t1.toString();
      els.team2Wins.textContent = t2.toString();

      const mapCounts = new Map();
      for (const m of matches){
        mapCounts.set(m.map, (mapCounts.get(m.map) || 0) + 1);
      }
      let topMap = "—";
      let topCount = 0;
      for (const [map, count] of mapCounts.entries()){
        if (count > topCount){
          topCount = count;
          topMap = map;
        }
      }
      els.topMap.textContent = topMap;
    }

    /* -----------------------------
       Team charts + last 5
    ------------------------------*/
    function setupTeamControls(){
      els.teamSelect.addEventListener("change", () => {
        rebuildTeamMapOptions();
        updateTeamSections();
      });

      els.teamMapSelect.addEventListener("change", () => {
        updateTeamSections();
      });
    }

    function populateTeamOptions(matches){
      const teams = new Set();
      for (const m of matches){
        teams.add(m.team1);
        teams.add(m.team2);
      }
      const sorted = [...teams].sort((a,b) => a.localeCompare(b));

      const prev = els.teamSelect.value;
      els.teamSelect.innerHTML = `<option value="">Select a team</option>`;
      for (const t of sorted){
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        els.teamSelect.appendChild(opt);
      }
      if (prev && sorted.includes(prev)) els.teamSelect.value = prev;
    }

    function reconcileTeamSelectionsAfterReload(){
      if (els.teamSelect.value){
        rebuildTeamMapOptions();
      } else {
        els.teamMapSelect.disabled = true;
        els.teamMapSelect.innerHTML = `<option value="${GENERAL_MAP_VALUE}">General (all maps)</option>`;
      }
    }

    function rebuildTeamMapOptions(){
      const team = els.teamSelect.value;
      els.teamMapSelect.innerHTML = "";

      const general = document.createElement("option");
      general.value = GENERAL_MAP_VALUE;
      general.textContent = "General (all maps)";
      els.teamMapSelect.appendChild(general);

      if (!team){
        els.teamMapSelect.disabled = true;
        els.teamMapSelect.value = GENERAL_MAP_VALUE;
        return;
      }

      const maps = new Set();
      for (const m of allMatches){
        if (m.team1 === team || m.team2 === team) maps.add(m.map);
      }
      const sortedMaps = [...maps].sort((a,b)=>a.localeCompare(b));

      for (const mp of sortedMaps){
        const opt = document.createElement("option");
        opt.value = mp;
        opt.textContent = mp;
        els.teamMapSelect.appendChild(opt);
      }

      els.teamMapSelect.disabled = false;
      if (![...els.teamMapSelect.options].some(o => o.value === els.teamMapSelect.value)){
        els.teamMapSelect.value = GENERAL_MAP_VALUE;
      }
    }

    function updateTeamSections(){
      updateWLChartAndBoxes();
      updateLast5();
      updateGeneralOverview();
    }

    function computeTeamStats(team, mapValue){
      const mapFilter = (mapValue && mapValue !== GENERAL_MAP_VALUE) ? mapValue : null;

      let wins = 0;
      let losses = 0;

      for (const m of allMatches){
        if (mapFilter && m.map !== mapFilter) continue;

        const as1 = (m.team1 === team);
        const as2 = (m.team2 === team);
        if (!as1 && !as2) continue;

        if (as1){
          if (m.winnerSide === "Team 1") wins++;
          else if (m.winnerSide === "Team 2") losses++;
        } else {
          if (m.winnerSide === "Team 2") wins++;
          else if (m.winnerSide === "Team 1") losses++;
        }
      }

      const total = wins + losses;
      const rate = total > 0 ? (wins / total) * 100 : 0;
      return { wins, losses, total, rate };
    }

    function buildCharts(){
      // Chart 1: Wins vs Losses
      const ctx1 = els.wlCanvas.getContext("2d");
      wlChart = new Chart(ctx1, {
        type: "bar",
        data: {
          labels: ["Wins", "Losses"],
          datasets: [{
            label: "Matches",
            data: [0, 0],
            backgroundColor: [
              "rgba(46, 229, 157, 0.45)",
              "rgba(255, 77, 109, 0.45)"
            ],
            borderColor: [
              "rgba(46, 229, 157, 0.85)",
              "rgba(255, 77, 109, 0.85)"
            ],
            borderWidth: 1.2,
            borderRadius: 10,
            maxBarThickness: 70
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (c) => ` ${c.raw} matches` } }
          },
          scales: {
            x: { ticks: { color: "rgba(255,255,255,0.80)" }, grid: { color: "rgba(255,255,255,0.06)" } },
            y: { beginAtZero: true, ticks: { color: "rgba(255,255,255,0.80)" }, grid: { color: "rgba(255,255,255,0.06)" } }
          }
        }
      });

      // Chart 2: Maps played (ascending by matches)
      const ctx2 = els.mapPlayCanvas.getContext("2d");
      mapPlayChart = new Chart(ctx2, {
        type: "bar",
        data: {
          labels: [],
          datasets: [{
            label: "Matches played",
            data: [],
            backgroundColor: "rgba(124, 92, 255, 0.35)",
            borderColor: "rgba(124, 92, 255, 0.85)",
            borderWidth: 1.1,
            borderRadius: 10
          }]
        },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => ` ${ctx.raw} matches`
              }
            }
          },
          scales: {
            x: { beginAtZero: true, ticks: { color: "rgba(255,255,255,0.80)" }, grid: { color: "rgba(255,255,255,0.06)" } },
            y: { ticks: { color: "rgba(255,255,255,0.80)" }, grid: { color: "rgba(255,255,255,0.00)" } }
          }
        }
      });
    }

    function setWLChartData(wins, losses){
      wlChart.data.datasets[0].data = [wins, losses];
      wlChart.update();
    }

    function updateWLChartAndBoxes(){
      const team = els.teamSelect.value;
      const mapValue = els.teamMapSelect.value || GENERAL_MAP_VALUE;

      if (!team){
        els.totalBox.textContent = "—";
        els.winsBox.textContent = "—";
        els.lossesBox.textContent = "—";
        els.rateBox.textContent = "—";
        setWLChartData(0,0);
        return;
      }

      const s = computeTeamStats(team, mapValue);

      els.totalBox.textContent = s.total.toString();
      els.winsBox.textContent = s.wins.toString();
      els.lossesBox.textContent = s.losses.toString();
      els.rateBox.textContent = (s.total > 0 ? `${s.rate.toFixed(1)}%` : "0%");

      setWLChartData(s.wins, s.losses);
    }

    function updateLast5(){
      const team = els.teamSelect.value;
      els.last5List.innerHTML = "";

      if (!team){
        els.last5List.innerHTML = `
          <div class="matchItem">
            <div class="matchLeft">
              <div class="matchLine1">
                <span class="badge neutral">Select a team</span>
                <span class="matchVs">to display matches</span>
              </div>
              <div class="matchLine2">
                <span class="badge neutral">—</span>
                <span class="badge neutral">—</span>
              </div>
            </div>
            <div class="matchRight">
              <span class="badge neutral">—</span>
            </div>
          </div>
        `;
        return;
      }

      const last = getLastMatches(team, 5);

      if (!last.length){
        els.last5List.innerHTML = `
          <div class="matchItem">
            <div class="matchLeft">
              <div class="matchLine1">
                <span class="badge warn">No data</span>
                <span class="matchVs">No matches found for this team.</span>
              </div>
            </div>
          </div>
        `;
        return;
      }

      for (const item of last){
        const badge = item.isWin ? "ok" : "danger";
        const wlText = item.isWin ? "W" : "L";

        const row = document.createElement("div");
        row.className = "matchItem";
        row.innerHTML = `
          <div class="matchLeft">
            <div class="matchLine1">
              <span class="badge ${badge}">${wlText}</span>
              <span class="matchVs">vs ${escapeHtml(item.opponent)}</span>
            </div>
            <div class="matchLine2">
              <span class="badge neutral">${escapeHtml(item.map)}</span>
              <span class="badge neutral">${item.teamScore}x${item.oppScore}</span>
              <span>${escapeHtml(item.sideLabel)}</span>
            </div>
          </div>
          <div class="matchRight">
            <span class="badge neutral">${escapeHtml(item.rawResult)}</span>
          </div>
        `;
        els.last5List.appendChild(row);
      }
    }

    function getLastMatches(team, n){
      const out = [];
      for (let i = allMatches.length - 1; i >= 0 && out.length < n; i--){
        const m = allMatches[i];
        const as1 = m.team1 === team;
        const as2 = m.team2 === team;
        if (!as1 && !as2) continue;

        const opponent = as1 ? m.team2 : m.team1;
        const teamScore = as1 ? m.score1 : m.score2;
        const oppScore  = as1 ? m.score2 : m.score1;

        const isWin = (as1 && m.winnerSide === "Team 1") || (as2 && m.winnerSide === "Team 2");
        const sideLabel = as1 ? "(Team 1)" : "(Team 2)";

        out.push({
          opponent,
          map: m.map,
          teamScore,
          oppScore,
          isWin,
          sideLabel,
          rawResult: `${m.score1}x${m.score2}`
        });
      }
      return out;
    }

    function updateGeneralOverview(){
      const team = els.teamSelect.value;

      if (!team){
        els.bestMapBox.textContent = "—";
        els.worstMapBox.textContent = "—";
        els.bestMapMeta.textContent = "";
        els.worstMapMeta.textContent = "";

        mapPlayChart.data.labels = [];
        mapPlayChart.data.datasets[0].data = [];
        mapPlayChart.update();
        return;
      }

      // Build per-map stats
      const byMap = new Map(); // map -> {wins, losses, total, rate}
      for (const m of allMatches){
        const as1 = m.team1 === team;
        const as2 = m.team2 === team;
        if (!as1 && !as2) continue;

        const key = m.map;
        if (!byMap.has(key)) byMap.set(key, { wins:0, losses:0, total:0, rate:0 });

        const s = byMap.get(key);
        const win = (as1 && m.winnerSide === "Team 1") || (as2 && m.winnerSide === "Team 2");
        if (win) s.wins++; else s.losses++;
        s.total++;
      }

      // compute rates
      for (const s of byMap.values()){
        s.rate = s.total > 0 ? (s.wins / s.total) * 100 : 0;
      }

      const entries = [...byMap.entries()]; // [map, stats]
      if (!entries.length){
        els.bestMapBox.textContent = "—";
        els.worstMapBox.textContent = "—";
        els.bestMapMeta.textContent = "";
        els.worstMapMeta.textContent = "";
        mapPlayChart.data.labels = [];
        mapPlayChart.data.datasets[0].data = [];
        mapPlayChart.update();
        return;
      }

      // best = highest win rate; tie-breaker: higher total
      const best = entries.slice().sort((a,b) => (b[1].rate - a[1].rate) || (b[1].total - a[1].total))[0];
      // worst = lowest win rate; tie-breaker: higher total
      const worst = entries.slice().sort((a,b) => (a[1].rate - b[1].rate) || (b[1].total - a[1].total))[0];

      els.bestMapBox.textContent = best[0];
      els.worstMapBox.textContent = worst[0];

      els.bestMapMeta.textContent = ` (${best[1].rate.toFixed(1)}% • ${best[1].wins}W-${best[1].losses}L • ${best[1].total})`;
      els.worstMapMeta.textContent = ` (${worst[1].rate.toFixed(1)}% • ${worst[1].wins}W-${worst[1].losses}L • ${worst[1].total})`;

      // maps played ascending by matches (as requested)
      const asc = entries.slice().sort((a,b) => (a[1].total - b[1].total) || a[0].localeCompare(b[0]));
      const labels = asc.map(e => e[0]);
      const data = asc.map(e => e[1].total);

      mapPlayChart.data.labels = labels;
      mapPlayChart.data.datasets[0].data = data;

      // enrich tooltip with W/L and rate
      mapPlayChart.options.plugins.tooltip.callbacks.label = (ctx) => {
        const map = ctx.label;
        const s = byMap.get(map);
        return ` ${s.total} matches • ${s.wins}W-${s.losses}L • ${s.rate.toFixed(1)}% win rate`;
      };

      mapPlayChart.update();
    }

    /* -----------------------------
       Excel loading
    ------------------------------*/
    async function loadExcelMatches(path, forceReload){
      const url = forceReload ? `${path}?v=${Date.now()}` : path;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} while fetching ${url}`);

      const buf = await res.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array" });

      const firstSheetName = wb.SheetNames[0];
      if (!firstSheetName) throw new Error("No sheets found in workbook");

      const ws = wb.Sheets[firstSheetName];
      const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });

      // Soft validation (non-blocking)
      const keys = rows.length ? Object.keys(rows[0]) : [];
      const hasExpected = EXPECTED_HEADERS.every(h => keys.includes(h));
      if (!hasExpected) console.warn("Unexpected headers detected:", keys);

      const matches = rows
        .filter(r => (r["Team 1"] || r["Team 2"] || r["Map"] || r["Result"]))
        .map(normalizeRow)
        .filter(Boolean);

      return matches;
    }

    function normalizeRow(r){
      const team1 = String(r["Team 1"] ?? "").trim();
      const team2 = String(r["Team 2"] ?? "").trim();
      const map   = String(r["Map"] ?? "").trim();
      const resultRaw = String(r["Result"] ?? "").trim();

      const { s1, s2 } = parseResult(resultRaw);
      if (!team1 || !team2 || !map || s1 === null || s2 === null) return null;

      let winnerSide = "Team 1";
      let winner = team1;

      if (s2 > s1){
        winnerSide = "Team 2";
        winner = team2;
      } else if (s1 === s2){
        winnerSide = "Tie";
        winner = "Tie";
      }

      return {
        team1,
        team2,
        map,
        score1: s1,
        score2: s2,
        winnerSide,
        winner,
        resultRaw
      };
    }

    function parseResult(text){
      const cleaned = String(text).replace(/\s+/g, "");
      const m = cleaned.match(/^(\d+)x(\d+)$/i);
      if (!m) return { s1: null, s2: null };
      return { s1: Number(m[1]), s2: Number(m[2]) };
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>

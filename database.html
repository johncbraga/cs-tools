<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ranking ‚Äî Elo + Streak + Tournaments + Prestige</title>

<!-- SheetJS (read/write XLSX in browser) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --bg0:#070A12;
    --bg1:#0B1022;
    --card:#0E1633cc;
    --card2:#0B122Bcc;
    --stroke:#22305f;
    --muted:#A8B1D6;
    --text:#EAF0FF;
    --accent:#7C5CFF;
    --accent2:#2DD4BF;
    --danger:#FB7185;
    --warn:#FBBF24;
    --good:#22C55E;
    --shadow: 0 18px 45px rgba(0,0,0,.45);
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", "Noto Sans", "Liberation Sans", sans-serif;
    --radius: 18px;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: var(--sans);
    color: var(--text);
    background:
      radial-gradient(900px 500px at 12% 0%, rgba(124,92,255,.35), transparent 60%),
      radial-gradient(900px 600px at 90% 20%, rgba(45,212,191,.18), transparent 55%),
      linear-gradient(180deg, var(--bg1), var(--bg0) 60%);
    min-height: 100vh;
    padding: 28px;
  }
  .container{ max-width: 1220px; margin: 0 auto; }
  header{
    display:flex; justify-content: space-between; align-items:flex-start;
    gap: 16px; margin-bottom: 18px;
  }
  h1{ margin:0; font-size: 26px; letter-spacing: .2px; }
  .sub{ color: var(--muted); margin-top: 6px; line-height: 1.4; font-size: 14px; }
  .pill{
    display:inline-flex; align-items:center; gap: 8px;
    padding: 8px 12px; border: 1px solid var(--stroke);
    border-radius: 999px; background: rgba(255,255,255,.03);
    font-size: 13px; color: var(--muted); user-select:none;
  }
  .grid{
    display:grid; grid-template-columns: 1.35fr 1fr;
    gap: 18px; align-items:start;
  }
  @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }
  .card{
    border: 1px solid var(--stroke);
    background: linear-gradient(180deg, var(--card), var(--card2));
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .card-head{
    padding: 14px 16px; border-bottom: 1px solid rgba(34,48,95,.85);
    display:flex; justify-content: space-between; align-items:center; gap: 12px;
  }
  .card-title{ font-weight: 650; letter-spacing: .2px; }
  .card-body{ padding: 16px; }
  .row{ display:flex; gap: 12px; flex-wrap: wrap; align-items:center; }
  .btn{
    border: 1px solid var(--stroke);
    background: rgba(255,255,255,.04);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 12px;
    cursor:pointer;
    font-weight: 600;
    transition: transform .08s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
  }
  .btn:hover{ background: rgba(255,255,255,.07); border-color: rgba(124,92,255,.55); }
  .btn:active{ transform: translateY(1px); }
  .btn.primary{
    border: none;
    background: linear-gradient(90deg, rgba(124,92,255,1), rgba(45,212,191,.95));
  }
  .btn.primary:hover{ filter: brightness(1.02); }
  .btn.danger{
    border: none;
    background: linear-gradient(90deg, rgba(251,113,133,1), rgba(251,191,36,.9));
    color:#1b1022;
  }
  .btn.good{
    border:none;
    background: linear-gradient(90deg, rgba(34,197,94,1), rgba(45,212,191,1));
    color:#04110e;
  }
  .btn.small{ padding: 8px 10px; border-radius: 10px; font-size: 13px; }
  .btn[disabled]{ opacity:.45; cursor:not-allowed; }
  .input, select{
    width: 100%;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--stroke);
    background: rgba(255,255,255,.03);
    color: var(--text);
    outline:none;
  }
  select option{ background: #0b122b; }
  label{
    display:block;
    font-size: 12px;
    color: var(--muted);
    margin: 10px 0 6px;
  }
  .mono{ font-family: var(--mono); }
  .alert{
    border: 1px solid var(--stroke);
    background: rgba(255,255,255,.03);
    padding: 12px 12px;
    border-radius: 14px;
    color: var(--text);
    margin: 12px 0 0;
    line-height: 1.4;
  }
  .alert small{ color: var(--muted); }
  .alert.warn{ border-color: rgba(251,191,36,.55); }
  .alert.good{ border-color: rgba(34,197,94,.55); }
  .alert.bad{ border-color: rgba(251,113,133,.55); }
  .table-wrap{
    max-height: 560px;
    overflow:auto;
    border-radius: 14px;
    border: 1px solid rgba(34,48,95,.75);
  }
  table{ width: 100%; border-collapse: collapse; font-size: 14px; }
  thead th{
    position: sticky; top:0;
    background: rgba(10,15,32,.96);
    border-bottom: 1px solid rgba(34,48,95,.75);
    padding: 10px 10px;
    text-align:left;
    color: var(--muted);
    font-weight: 650;
    z-index: 1;
  }
  tbody td{ padding: 10px 10px; border-bottom: 1px solid rgba(34,48,95,.35); }
  tbody tr:hover{ background: rgba(255,255,255,.03); }
  td.num, th.num{ text-align:right; font-family: var(--mono); }
  .badge{
    display:inline-flex;
    align-items:center;
    padding: 4px 9px;
    border-radius: 999px;
    font-size: 12px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
  }
  .tierS{ background: rgba(124,92,255,.18); border-color: rgba(124,92,255,.45); }
  .tier1{ background: rgba(37,99,235,.18); border-color: rgba(37,99,235,.45); }
  .tier2{ background: rgba(34,197,94,.16); border-color: rgba(34,197,94,.40); }
  .tier3{ background: rgba(100,116,139,.16); border-color: rgba(100,116,139,.35); }
  .bonus{ background: rgba(45,212,191,.14); border-color: rgba(45,212,191,.35); }
  .split{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  @media(max-width:520px){ .split{ grid-template-columns: 1fr; } }
  .footer-note{ margin-top: 14px; color: var(--muted); font-size: 13px; line-height: 1.5; }
  .hr{ height:1px; background: rgba(34,48,95,.65); margin: 14px 0; }
</style>
</head>

<body>
<div class="container">

<header>
  <div>
    <h1>Ranking</h1>
    <div class="sub">
      Elo (Points) + Dynamic K (Streak + Tournament Bonus) + Season Reset with Prestige<br>
      Default file: <span class="mono">file/ranking.xlsx</span> (GitHub Pages is static ‚Äî download the updated Excel after changes)
    </div>
  </div>

  <div class="row">
    <span class="pill">üìÑ Auto-load: <span class="mono" id="excelUrlLabel">file/ranking.xlsx</span></span>
    <button class="btn small" id="btnReload">Reload</button>
    <button class="btn primary small" id="btnDownload">Download updated Excel</button>
  </div>
</header>

<div id="alerts"></div>

<div class="grid">

  <!-- TABLE -->
  <section class="card">
    <div class="card-head">
      <div class="card-title">Current standings</div>
      <div class="row">
        <label style="margin:0;color:var(--muted);font-size:12px;">Manual load (.xlsx)</label>
        <input class="input" style="width:260px" id="fileInput" type="file" accept=".xlsx" />
      </div>
    </div>
    <div class="card-body">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Team</th>
              <th class="num">Points</th>
              <th class="num">Wins</th>
              <th class="num">Losses</th>
              <th class="num">Streak</th>
              <th class="num">Majors</th>
              <th class="num">Trophies</th>
              <th class="num">Prestige</th>
              <th>Tier</th>
              <th>Region</th>
              <th>Bonus</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="footer-note">
        <strong>Note:</strong> This site can‚Äôt write back to GitHub Pages. After updates, click
        <strong>‚ÄúDownload updated Excel‚Äù</strong> and replace <span class="mono">file/ranking.xlsx</span> in your repo.
      </div>
    </div>
  </section>

  <!-- CONTROLS -->
  <aside>

    <!-- VERSUS -->
    <section class="card" style="margin-bottom:18px;">
      <div class="card-head">
        <div class="card-title">Versus</div>
        <span class="pill">‚öôÔ∏è Elo + Streak + Bonus</span>
      </div>
      <div class="card-body">

        <div class="split">
          <div>
            <label>Team A</label>
            <select id="teamA"></select>
          </div>
          <div>
            <label>Team B</label>
            <select id="teamB"></select>
          </div>
        </div>

        <button class="btn" style="margin-top:12px;width:100%;" id="btnCalc">Calculate deltas</button>

        <div id="versusBox" class="alert" style="display:none;">
          <div><strong>Expected:</strong> A=<span class="mono" id="EA"></span> | B=<span class="mono" id="EB"></span></div>
          <div><strong>K_final:</strong> A=<span class="mono" id="KA"></span> | B=<span class="mono" id="KB"></span></div>
          <div class="hr"></div>

          <div class="split">
            <div>
              <div class="mono">A wins: ŒîA <span id="dA_win"></span> | ŒîB <span id="dB_lose"></span></div>
              <div class="mono">B wins: ŒîA <span id="dA_lose"></span> | ŒîB <span id="dB_win"></span></div>
              <div class="mono">Draw:  ŒîA <span id="dA_draw"></span> | ŒîB <span id="dB_draw"></span></div>
            </div>
            <div>
              <label>Match result</label>
              <select id="matchResult">
                <option value="A">Team A wins</option>
                <option value="B">Team B wins</option>
                <option value="D">Draw</option>
              </select>

              <button class="btn good" style="margin-top:10px;width:100%;" id="btnApplyMatch">
                Apply match
              </button>
            </div>
          </div>

          <small>Applies: Points (Elo), Wins/Losses, Streak, and consumes 1 bonus game if active.</small>
        </div>

      </div>
    </section>

    <!-- TOURNAMENT WIN -->
    <section class="card" style="margin-bottom:18px;">
      <div class="card-head">
        <div class="card-title">Tournament win (1st place)</div>
        <span class="pill">üèÜ Updates Majors / Trophies</span>
      </div>
      <div class="card-body">
        <label>Team</label>
        <select id="tourneyTeam"></select>

        <label>Tournament type</label>
        <select id="tourneyType">
          <option value="regional">Regional (counts as Trophies)</option>
          <option value="global">Global (counts as Trophies)</option>
          <option value="major">Major (counts as Majors)</option>
        </select>

        <button class="btn primary" style="margin-top:12px;width:100%;" id="btnApplyTourney">
          Apply tournament win
        </button>

        <div class="alert warn" style="margin-top:12px;">
          <div><strong>Temporary bonus:</strong></div>
          <small>
            Regional: +5% for 5 games ‚Ä¢ Global: +10% for 8 ‚Ä¢ Major: +20% for 12<br>
            (affects K only ‚Äî no fixed point grants).
          </small>
        </div>
      </div>
    </section>

    <!-- SEASON RESET -->
    <section class="card">
      <div class="card-head">
        <div class="card-title">Season Reset (Global)</div>
        <span class="pill">‚ôªÔ∏è Prestige preserves history</span>
      </div>
      <div class="card-body">

        <div class="alert">
          <div><strong>Fixed reset rules:</strong></div>
          <small class="mono">basePoints = 1000</small><br>
          <small class="mono">keep = 0.35</small><br>
          <small class="mono">newPoints = 1000 + (oldPoints - 1000) * 0.35</small><br>
          <small class="mono">prestige += oldPoints</small><br>
          <small>Streak resets to 0, and seasonal Wins/Losses reset to 0. Majors & Trophies stay.</small>
        </div>

        <button class="btn" style="margin-top:12px;width:100%;" id="btnPreviewReset">
          Preview season reset
        </button>

        <div id="resetPreview" class="alert warn" style="display:none;">
          <div><strong>Preview:</strong></div>
          <div id="resetPreviewText"></div>
          <small>This is irreversible in the spreadsheet until you replace the file. Confirm only if you‚Äôre ready.</small>
        </div>

        <button class="btn danger" style="margin-top:12px;width:100%;" id="btnConfirmReset" disabled>
          Confirm season reset
        </button>

      </div>
    </section>

  </aside>
</div>

</div>

<script>
/* ===================== RANKING CONFIG ===================== */
const K_BASE = 30.0;
const ELO_DIVISOR = 400.0;
const STREAK_ALPHA = 0.10;   // up to +10%
const STREAK_SCALE = 5.0;    // tanh(streak/5)
const K_HARD_CAP_MULT = 1.35;

const TOURNEY_BONUS = {
  none:     { bonus: 0.00, dur: 0  },
  regional: { bonus: 0.05, dur: 5  },
  global:   { bonus: 0.10, dur: 8  },
  major:    { bonus: 0.20, dur: 12 },
};

/* ===================== EXCEL COLUMNS ===================== */
const COL = {
  TEAM: "Team",
  V: "Victories",
  S: "Streak",
  L: "Loses",
  PTS: "Points",
  MAJ: "Majors",
  PRE: "Prestige",
  TRO: "Tournaments Trophies",
  TIER: "Tier",
  REG: "Region",
  BONUS_TYPE: "BonusType",
  BONUS_REM: "BonusRemaining",
  UPDATED: "LastUpdated"
};

let teams = [];
let extraCols = [];
let resetPreviewReady = false;

/* ===================== FIXED SEASON RESET RULES ===================== */
const RESET_BASE = 1000;
const RESET_KEEP = 0.35; // stable long-term compression
// Prestige gain rule requested: comparable to team points at reset -> add the full oldPoints.
function prestigeGainFromPoints(oldPoints){
  return Math.round(Number(oldPoints) || 0);
}

/* ===================== HELPERS ===================== */
function htmlEscape(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function showAlert(msg, kind="good"){
  const box = document.getElementById("alerts");
  const cls = kind === "bad" ? "alert bad" : (kind === "warn" ? "alert warn" : "alert good");
  box.innerHTML = `<div class="${cls}">${msg}</div>`;
}

/* ===================== MATH ===================== */
function expectedScore(ra, rb){
  return 1.0 / (1.0 + Math.pow(10, (rb - ra) / ELO_DIVISOR));
}
function tanh(x){
  const e2x = Math.exp(2*x);
  return (e2x - 1) / (e2x + 1);
}
function streakBonus(streak){
  streak = Number(streak) || 0;
  return STREAK_ALPHA * tanh(streak / STREAK_SCALE);
}
function tourneyBonus(type, remaining){
  type = String(type || "none").toLowerCase();
  remaining = Number(remaining) || 0;
  if (remaining <= 0) return 0.0;
  return (TOURNEY_BONUS[type] || TOURNEY_BONUS.none).bonus;
}
function kFinal(teamRow){
  const s = Number(teamRow[COL.S]) || 0;
  const bt = String(teamRow[COL.BONUS_TYPE] || "none").toLowerCase();
  const br = Number(teamRow[COL.BONUS_REM]) || 0;

  let k = K_BASE * (1 + streakBonus(s)) * (1 + tourneyBonus(bt, br));
  const cap = K_BASE * K_HARD_CAP_MULT;
  return Math.min(k, cap);
}

function tierFromPoints(points){
  const r = Number(points) || 0;
  if (r >= 1700) return "Tier S";
  if (r >= 1400) return "Tier 1";
  if (r >= 1100) return "Tier 2";
  return "Tier 3";
}
function tierClass(tier){
  if (tier === "Tier S") return "badge tierS";
  if (tier === "Tier 1") return "badge tier1";
  if (tier === "Tier 2") return "badge tier2";
  return "badge tier3";
}

function ensureOptionalCols(row){
  if (!(COL.BONUS_TYPE in row)) row[COL.BONUS_TYPE] = "none";
  if (!(COL.BONUS_REM  in row)) row[COL.BONUS_REM]  = 0;
  if (!(COL.UPDATED    in row)) row[COL.UPDATED]    = "";
}

function normalizeRow(row){
  const r = { ...row };

  // Required columns defaults
  if (!(COL.TEAM in r)) r[COL.TEAM] = "";
  r[COL.TEAM] = String(r[COL.TEAM]).trim();

  if (!(COL.V in r)) r[COL.V] = 0;
  if (!(COL.S in r)) r[COL.S] = 0;
  if (!(COL.L in r)) r[COL.L] = 0;
  if (!(COL.PTS in r)) r[COL.PTS] = RESET_BASE;
  if (!(COL.MAJ in r)) r[COL.MAJ] = 0;
  if (!(COL.PRE in r)) r[COL.PRE] = 0;
  if (!(COL.TRO in r)) r[COL.TRO] = 0;
  if (!(COL.TIER in r)) r[COL.TIER] = tierFromPoints(r[COL.PTS]);
  if (!(COL.REG in r)) r[COL.REG] = "";

  r[COL.V]   = parseInt(r[COL.V]   || 0, 10) || 0;
  r[COL.S]   = parseInt(r[COL.S]   || 0, 10) || 0;
  r[COL.L]   = parseInt(r[COL.L]   || 0, 10) || 0;
  r[COL.MAJ] = parseInt(r[COL.MAJ] || 0, 10) || 0;
  r[COL.PRE] = Number(r[COL.PRE] || 0); // allow big / non-integer prestige if needed
  if (!Number.isFinite(r[COL.PRE])) r[COL.PRE] = 0;
  r[COL.TRO] = parseInt(r[COL.TRO] || 0, 10) || 0;

  r[COL.PTS] = Number(r[COL.PTS]);
  if (!Number.isFinite(r[COL.PTS])) r[COL.PTS] = RESET_BASE;

  ensureOptionalCols(r);

  r[COL.BONUS_TYPE] = String(r[COL.BONUS_TYPE] || "none").toLowerCase();
  if (!(r[COL.BONUS_TYPE] in TOURNEY_BONUS)) r[COL.BONUS_TYPE] = "none";
  r[COL.BONUS_REM] = parseInt(r[COL.BONUS_REM] || 0, 10) || 0;

  r[COL.TIER] = tierFromPoints(r[COL.PTS]);
  return r;
}

function dedupeByTeam(rows){
  const map = new Map();
  for (const r of rows){
    if (!r[COL.TEAM]) continue;
    map.set(r[COL.TEAM], r);
  }
  return Array.from(map.values());
}

/* ===================== RENDER ===================== */
function fillSelects(){
  const names = teams.map(t => t[COL.TEAM]).sort((a,b)=>a.localeCompare(b));
  const ids = ["teamA","teamB","tourneyTeam"];
  for (const id of ids){
    const sel = document.getElementById(id);
    sel.innerHTML = names.map(n => `<option value="${htmlEscape(n)}">${htmlEscape(n)}</option>`).join("");
  }
  if (names.length >= 2){
    document.getElementById("teamA").value = names[0];
    document.getElementById("teamB").value = names[1];
  }
}

function renderTable(){
  teams.sort((a,b)=>(Number(b[COL.PTS])||0) - (Number(a[COL.PTS])||0));
  const tb = document.getElementById("tableBody");
  tb.innerHTML = "";

  for (const t of teams){
    const pts = Number(t[COL.PTS]) || 0;
    const tier = t[COL.TIER];

    const bt = String(t[COL.BONUS_TYPE] || "none");
    const br = Number(t[COL.BONUS_REM] || 0);
    const bonusLabel = (br>0 && bt!=="none")
      ? `<span class="badge bonus mono">${htmlEscape(bt)} (${br})</span>`
      : `<span class="badge mono">none</span>`;

    tb.innerHTML += `
      <tr>
        <td>${htmlEscape(t[COL.TEAM])}</td>
        <td class="num">${pts.toFixed(2)}</td>
        <td class="num">${t[COL.V]}</td>
        <td class="num">${t[COL.L]}</td>
        <td class="num">${t[COL.S]}</td>
        <td class="num">${t[COL.MAJ]}</td>
        <td class="num">${t[COL.TRO]}</td>
        <td class="num">${Number(t[COL.PRE]||0).toFixed(0)}</td>
        <td><span class="${tierClass(tier)}">${htmlEscape(tier)}</span></td>
        <td>${htmlEscape(t[COL.REG])}</td>
        <td>${bonusLabel}</td>
      </tr>
    `;
  }
  fillSelects();
}

/* ===================== VERSUS ===================== */
function computeDeltas(A, B){
  const ra = Number(A[COL.PTS]) || 0;
  const rb = Number(B[COL.PTS]) || 0;

  const ea = expectedScore(ra, rb);
  const eb = 1 - ea;

  const kA = kFinal(A);
  const kB = kFinal(B);

  const d = (k,s,e)=> k*(s-e);

  return {
    ea, eb, kA, kB,
    A_win: { dA: d(kA,1,ea), dB: d(kB,0,eb) },
    B_win: { dA: d(kA,0,ea), dB: d(kB,1,eb) },
    draw:  { dA: d(kA,0.5,ea), dB: d(kB,0.5,eb) }
  };
}

function consumeBonus(team){
  let rem = Number(team[COL.BONUS_REM]) || 0;
  if (rem > 0){
    rem -= 1;
    team[COL.BONUS_REM] = rem;
    if (rem <= 0){
      team[COL.BONUS_TYPE] = "none";
      team[COL.BONUS_REM] = 0;
    }
  }
}

function applyMatch(result){
  const aName = document.getElementById("teamA").value;
  const bName = document.getElementById("teamB").value;

  if (!aName || !bName || aName === bName){
    showAlert("Please choose two different teams.", "warn");
    return;
  }

  const A = teams.find(t=>t[COL.TEAM]===aName);
  const B = teams.find(t=>t[COL.TEAM]===bName);
  if (!A || !B){
    showAlert("Team not found in the spreadsheet.", "bad");
    return;
  }

  const deltas = computeDeltas(A, B);

  if (result === "A"){
    A[COL.PTS] = (Number(A[COL.PTS])||0) + deltas.A_win.dA;
    B[COL.PTS] = (Number(B[COL.PTS])||0) + deltas.A_win.dB;

    A[COL.V] += 1;
    B[COL.L] += 1;

    A[COL.S] += 1;
    B[COL.S] = 0;
  } else if (result === "B"){
    A[COL.PTS] = (Number(A[COL.PTS])||0) + deltas.B_win.dA;
    B[COL.PTS] = (Number(B[COL.PTS])||0) + deltas.B_win.dB;

    B[COL.V] += 1;
    A[COL.L] += 1;

    B[COL.S] += 1;
    A[COL.S] = 0;
  } else {
    // Draw
    A[COL.PTS] = (Number(A[COL.PTS])||0) + deltas.draw.dA;
    B[COL.PTS] = (Number(B[COL.PTS])||0) + deltas.draw.dB;

    A[COL.S] = 0;
    B[COL.S] = 0;
  }

  consumeBonus(A);
  consumeBonus(B);

  A[COL.TIER] = tierFromPoints(A[COL.PTS]);
  B[COL.TIER] = tierFromPoints(B[COL.PTS]);

  A[COL.UPDATED] = new Date().toISOString();
  B[COL.UPDATED] = new Date().toISOString();

  renderTable();
  showAlert("Match applied. Download the updated Excel to persist changes.", "good");
}

document.getElementById("btnCalc").addEventListener("click", ()=>{
  if (!teams.length){
    showAlert("Load the Excel first.", "warn");
    return;
  }
  const aName = document.getElementById("teamA").value;
  const bName = document.getElementById("teamB").value;
  if (!aName || !bName || aName===bName){
    showAlert("Please choose two different teams.", "warn");
    return;
  }

  const A = teams.find(t=>t[COL.TEAM]===aName);
  const B = teams.find(t=>t[COL.TEAM]===bName);

  const deltas = computeDeltas(A,B);

  document.getElementById("EA").textContent = deltas.ea.toFixed(4);
  document.getElementById("EB").textContent = deltas.eb.toFixed(4);
  document.getElementById("KA").textContent = deltas.kA.toFixed(2);
  document.getElementById("KB").textContent = deltas.kB.toFixed(2);

  document.getElementById("dA_win").textContent  = deltas.A_win.dA.toFixed(2);
  document.getElementById("dB_lose").textContent = deltas.A_win.dB.toFixed(2);
  document.getElementById("dA_lose").textContent = deltas.B_win.dA.toFixed(2);
  document.getElementById("dB_win").textContent  = deltas.B_win.dB.toFixed(2);
  document.getElementById("dA_draw").textContent = deltas.draw.dA.toFixed(2);
  document.getElementById("dB_draw").textContent = deltas.draw.dB.toFixed(2);

  document.getElementById("versusBox").style.display = "block";
});

document.getElementById("btnApplyMatch").addEventListener("click", ()=>{
  const res = document.getElementById("matchResult").value;
  applyMatch(res);
});

/* ===================== TOURNAMENT WIN ===================== */
function applyTourneyWin(){
  const name = document.getElementById("tourneyTeam").value;
  const type = document.getElementById("tourneyType").value;

  const T = teams.find(t=>t[COL.TEAM]===name);
  if (!T){
    showAlert("Team not found.", "bad");
    return;
  }

  // Update requested columns:
  if (type === "major"){
    T[COL.MAJ] += 1;
  } else {
    // regional + global count in the same trophies column
    T[COL.TRO] += 1;
  }

  // Activate temporary bonus
  ensureOptionalCols(T);
  T[COL.BONUS_TYPE] = type;
  T[COL.BONUS_REM] = TOURNEY_BONUS[type].dur;

  T[COL.UPDATED] = new Date().toISOString();

  renderTable();
  showAlert("Tournament win applied (Majors/Trophies updated + temporary bonus activated).", "good");
}
document.getElementById("btnApplyTourney").addEventListener("click", applyTourneyWin);

/* ===================== SEASON RESET (GLOBAL) ===================== */
function previewSeasonReset(){
  if (!teams.length){
    showAlert("Load the Excel first.", "warn");
    return;
  }

  // compute preview stats without mutating
  let sumOld=0, sumNew=0;
  let maxDrop = -Infinity;
  let biggest = null;

  for (const t of teams){
    const oldP = Number(t[COL.PTS]) || RESET_BASE;
    const newP = RESET_BASE + (oldP - RESET_BASE) * RESET_KEEP;
    sumOld += oldP;
    sumNew += newP;
    const drop = oldP - newP;
    if (drop > maxDrop){
      maxDrop = drop;
      biggest = { team: t[COL.TEAM], oldP, newP, drop, preGain: prestigeGainFromPoints(oldP) };
    }
  }

  const avgOld = sumOld / teams.length;
  const avgNew = sumNew / teams.length;

  const box = document.getElementById("resetPreview");
  const text = document.getElementById("resetPreviewText");
  box.style.display = "block";

  text.innerHTML = `
    <div>Teams affected: <span class="mono">${teams.length}</span></div>
    <div>Average Points: <span class="mono">${avgOld.toFixed(2)}</span> ‚Üí <span class="mono">${avgNew.toFixed(2)}</span></div>
    <div>Biggest compression: <span class="mono">${htmlEscape(biggest?.team || "")}</span>
      (<span class="mono">${biggest?.oldP.toFixed(2)}</span> ‚Üí <span class="mono">${biggest?.newP.toFixed(2)}</span>,
      Prestige +<span class="mono">${biggest?.preGain}</span>)
    </div>
  `;

  resetPreviewReady = true;
  document.getElementById("btnConfirmReset").disabled = false;
  showAlert("Preview ready. Click 'Confirm season reset' to apply.", "warn");
}

function confirmSeasonReset(){
  if (!resetPreviewReady){
    showAlert("Please run the preview first.", "warn");
    return;
  }
  // Apply changes
  for (const t of teams){
    const oldP = Number(t[COL.PTS]) || RESET_BASE;
    const newP = RESET_BASE + (oldP - RESET_BASE) * RESET_KEEP;

    // prestige comparable to points: add full old points
    const preAdd = prestigeGainFromPoints(oldP);
    t[COL.PRE] = Number(t[COL.PRE] || 0) + preAdd;

    // reset season stats
    t[COL.PTS] = newP;
    t[COL.V] = 0;
    t[COL.L] = 0;
    t[COL.S] = 0;

    // clear active bonus to start season clean
    ensureOptionalCols(t);
    t[COL.BONUS_TYPE] = "none";
    t[COL.BONUS_REM] = 0;

    // tier from points
    t[COL.TIER] = tierFromPoints(t[COL.PTS]);

    t[COL.UPDATED] = new Date().toISOString();
  }

  resetPreviewReady = false;
  document.getElementById("btnConfirmReset").disabled = true;

  renderTable();
  showAlert("Season reset applied to all teams. Download the updated Excel to persist changes.", "good");
}

document.getElementById("btnPreviewReset").addEventListener("click", previewSeasonReset);
document.getElementById("btnConfirmReset").addEventListener("click", confirmSeasonReset);

/* ===================== EXCEL I/O ===================== */
function computeExtraColsFromSheet(headers){
  const official = new Set(Object.values(COL));
  return headers.filter(h => !official.has(h));
}

function toExportRows(){
  return teams.map(t=>{
    ensureOptionalCols(t);

    const row = {
      [COL.TEAM]: t[COL.TEAM],
      [COL.V]: t[COL.V],
      [COL.S]: t[COL.S],
      [COL.L]: t[COL.L],
      [COL.PTS]: Number(t[COL.PTS]),
      [COL.MAJ]: t[COL.MAJ],
      [COL.PRE]: Number(t[COL.PRE] || 0),
      [COL.TRO]: t[COL.TRO],
      [COL.TIER]: t[COL.TIER],
      [COL.REG]: t[COL.REG],
      [COL.BONUS_TYPE]: t[COL.BONUS_TYPE],
      [COL.BONUS_REM]: t[COL.BONUS_REM],
      [COL.UPDATED]: t[COL.UPDATED] || ""
    };

    for (const c of extraCols){
      row[c] = t[c] ?? "";
    }
    return row;
  });
}

function downloadExcel(){
  if (!teams.length){
    showAlert("Nothing to download. Load the Excel first.", "warn");
    return;
  }
  const rows = toExportRows();
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "ranking");
  XLSX.writeFile(wb, "ranking_updated.xlsx");
  showAlert("Excel generated: <strong>ranking_updated.xlsx</strong>. Replace <span class='mono'>file/ranking.xlsx</span> in your repo.", "good");
}
document.getElementById("btnDownload").addEventListener("click", downloadExcel);

/* ===================== AUTO-LOAD FIX ===================== */
/**
 * This is the key fix:
 * Use a base-safe URL so GitHub Pages works regardless of repo subpath or page filename.
 */
function getExcelUrl(){
  const base = new URL(".", window.location.href);            // folder of current page
  return new URL("file/ranking.xlsx", base).toString();       // absolute-safe
}

async function loadFromUrl(){
  const excelUrl = getExcelUrl();
  document.getElementById("excelUrlLabel").textContent = excelUrl.replace(window.location.origin, "");
  try{
    const resp = await fetch(excelUrl, { cache: "no-store" });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const ab = await resp.arrayBuffer();
    loadFromArrayBuffer(ab);
    showAlert(`Loaded successfully from <span class="mono">${htmlEscape(excelUrl)}</span>`, "good");
  }catch(e){
    showAlert(
      `Auto-load failed from <span class="mono">${htmlEscape(excelUrl)}</span>.<br>
       <small>Common causes: file name case mismatch, missing file in published branch, or wrong Pages branch. Error: ${htmlEscape(e.message)}</small>`,
      "warn"
    );
  }
}

function loadFromArrayBuffer(ab){
  const wb = XLSX.read(ab, { type:"array" });
  const sheetName = wb.SheetNames[0];
  const ws = wb.Sheets[sheetName];

  // preserve extra columns
  const range = XLSX.utils.decode_range(ws["!ref"]);
  const headers = [];
  for (let C = range.s.c; C <= range.e.c; C++){
    const cell = ws[XLSX.utils.encode_cell({r: range.s.r, c: C})];
    headers.push(cell ? String(cell.v).trim() : "");
  }
  extraCols = computeExtraColsFromSheet(headers.filter(Boolean));

  const raw = XLSX.utils.sheet_to_json(ws, { defval: "" });
  teams = dedupeByTeam(raw.map(normalizeRow));

  if (!teams.length){
    showAlert(`Sheet loaded but no valid rows found (missing "${COL.TEAM}" column).`, "warn");
  }

  renderTable();
  document.getElementById("versusBox").style.display = "none";
  document.getElementById("resetPreview").style.display = "none";
  document.getElementById("btnConfirmReset").disabled = true;
  resetPreviewReady = false;
}

document.getElementById("btnReload").addEventListener("click", loadFromUrl);

document.getElementById("fileInput").addEventListener("change", async (ev)=>{
  const file = ev.target.files?.[0];
  if (!file) return;
  const ab = await file.arrayBuffer();
  loadFromArrayBuffer(ab);
  showAlert(`Manual load: <span class="mono">${htmlEscape(file.name)}</span>`, "good");
});

// INIT
loadFromUrl();
</script>
</body>
</html>
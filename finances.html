<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ultimate eSports Manager v6.4</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f0f0f; color: #f0f0f0; margin: 0; padding: 20px; }
        .container { max-width: 1300px; margin: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: 1 / -1; }
        .section { background: #1a1a1a; padding: 20px; border-radius: 10px; border: 1px solid #333; }
        h1, h2, h3 { color: #4caf50; margin-top: 0; }
        
        input, select { background: #2a2a2a; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 5px; margin: 5px 0; width: calc(100% - 22px); }
        button { cursor: pointer; padding: 10px 15px; border: none; border-radius: 5px; background: #4caf50; color: white; font-weight: bold; transition: 0.2s; margin-top: 5px; }
        button:hover { background: #45a049; }
        .btn-blue { background: #2196f3; } .btn-red { background: #f44336; } .btn-orange { background: #ff9800; } .btn-purple { background: #9c27b0; }
        
        .list-container { height: 280px; overflow-y: auto; background: #111; padding: 10px; border-radius: 5px; border: 1px solid #333; }
        .item-card { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #222; font-size: 0.9em; }
        .log { background: #000; padding: 15px; height: 150px; overflow-y: auto; font-family: 'Courier New', monospace; color: #00ff00; border-radius: 5px; font-size: 12px; }
        .warning { color: #ff9800; } .expired { color: #f44336; font-weight: bold; }
        .discount-badge { background: #ffeb3b; color: #000; padding: 2px 5px; border-radius: 3px; font-size: 0.8em; font-weight: bold; margin-left: 5px; }
        
        .tab-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .tab-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .control-group { margin-bottom: 10px; }
        
        /* Dashboard Styles */
        .dash-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #333; }
        .dash-row.total { font-weight: bold; border-bottom: none; margin-top: 10px; font-size: 1.1em; }
        .text-green { color: #4caf50; } .text-red { color: #f44336; } .text-blue { color: #2196f3; }
    </style>
</head>
<body>

<div class="container">
    <div class="section full-width">
        <h1>üéÆ Ultimate eSports Management System</h1>
        <div class="tab-grid">
            <div><label>Finances (finances.xlsx):</label><input type="file" id="upload-finances" accept=".xlsx"></div>
            <div><label>Players (players.xlsx):</label><input type="file" id="upload-players" accept=".xlsx"></div>
        </div>
    </div>

    <div class="section full-width" style="border: 2px solid #2196f3;">
        <h2 style="color: #2196f3; display: flex; justify-content: space-between;">
            <span>üìä Dashboard & Active Team</span>
            <span style="font-size: 0.6em; color: #aaa;">This selection controls your purchases in the Market</span>
        </h2>
        <select id="dash-team-select" onchange="updateDashboardAndMarket()" style="font-size: 1.2em; font-weight: bold;"></select>
        <div id="dash-content" style="background: #111; padding: 15px; border-radius: 5px; margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            </div>
    </div>

    <div class="section">
        <h2>üèÜ Tournament & MVP</h2>
        <div class="tab-grid">
            <div>
                <h3>Tournament Win</h3>
                <select id="tourney-team-select"></select>
                <input type="number" id="prize-amount" placeholder="Total Prize ($)">
                <button onclick="distributeTourneyPrize()">Distribute (60% / 40%)</button>
            </div>
            <div>
                <h3>Individual Performance</h3>
                <select id="perf-player-select" title="Select Player"></select>
                <select id="perf-tier">
                    <option value="region">Region (10k)</option>
                    <option value="global">Global (20k)</option>
                    <option value="major">Major (50k)</option>
                </select>
                <select id="perf-type">
                    <option value="mvp">MVP</option>
                    <option value="evp">EVP</option>
                    <option value="vp">VP</option>
                </select>
                <button onclick="applyIndividualPerformance()" class="btn-blue">Apply Reward</button>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>üõí Transfer Market</h2>
        <div class="tab-grid-3">
            <div class="control-group">
                <label>Role Filter:</label>
                <select id="market-filter" onchange="refreshMarket()">
                    <option value="all">All Roles</option>
                    <option value="none">Free Agents (none)</option>
                    <option value="Bench">Benched Players</option>
                    <option value="Starter">Active Starters</option>
                </select>
            </div>
            <div class="control-group">
                <label>Team Filter:</label>
                <select id="market-team-filter" onchange="refreshMarket()">
                    <option value="all">All Teams</option>
                </select>
            </div>
            <div class="control-group">
                <label>Contract Length:</label>
                <select id="market-duration">
                    <option value="1">1 Month</option><option value="2">2 Months</option>
                    <option value="3">3 Months</option><option value="4">4 Months</option>
                    <option value="5">5 Months</option><option value="6" selected>6 Months</option>
                </select>
            </div>
        </div>
        <div id="market-list" class="list-container"></div>
    </div>

    <div class="section">
        <h2>‚ö†Ô∏è Contract Alerts</h2>
        <label>Renewal Duration (1-6m):</label>
        <select id="renew-duration">
            <option value="1">1 Month</option><option value="2">2 Months</option>
            <option value="3">3 Months</option><option value="4">4 Months</option>
            <option value="5">5 Months</option><option value="6" selected>6 Months</option>
        </select>
        <div id="contract-alerts" class="list-container"></div>
    </div>

    <div class="section">
        <h2>‚öôÔ∏è Management Tools</h2>
        <div class="tab-grid">
            <div>
                <button onclick="runMonthlyCycle()" class="btn-blue" style="width: 100%; height: 50px;">RUN MONTHLY CYCLE</button>
                <p><small>Processes Tier Income, exact Excel costs, Salaries, and reduces contracts.</small></p>
            </div>
            <div>
                <select id="reset-team-select"></select>
                <button onclick="resetBankrupt()" class="btn-red" style="width: 100%;">Reset Target Bank (0)</button>
                <button onclick="applySeasonReset()" class="btn-orange" style="width: 100%; margin-top: 10px;">Season Reset (-30% MV)</button>
            </div>
        </div>
    </div>

    <div class="section full-width">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>üìã Activity Log</h3>
            <div>
                <button onclick="undo()" class="btn-red">Undo</button>
                <button onclick="exportExcels()" class="btn-blue">üì• Export Updated Excels</button>
            </div>
        </div>
        <div id="action-log" class="log">> Ready. Upload files.</div>
    </div>
</div>

<script>
    let finances = [];
    let players = [];
    let history = [];
    let temporaryOffers = {}; // Armazena ofertas de buyout modificadas temporariamente

    // --- File Handling ---
    document.getElementById('upload-finances').addEventListener('change', (e) => handleExcel(e, d => {
        finances = d;
        populateTeamDropdowns();
        addLog("Finance file loaded.");
    }));

    document.getElementById('upload-players').addEventListener('change', (e) => handleExcel(e, d => {
        players = d;
        populatePlayerDropdown();
        refreshMarket();
        checkContracts();
        addLog("Players file loaded.");
    }));

    function handleExcel(e, cb) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (evt) => {
            const wb = XLSX.read(evt.target.result, { type: 'binary' });
            cb(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
        };
        reader.readAsBinaryString(file);
    }

    function populateTeamDropdowns() {
        const options = finances.map(t => `<option value="${t.TeamName}">${t.TeamName}</option>`).join('');
        document.getElementById('tourney-team-select').innerHTML = options;
        document.getElementById('reset-team-select').innerHTML = options;
        document.getElementById('dash-team-select').innerHTML = options;
        
        // Populate Market Team Filter
        document.getElementById('market-team-filter').innerHTML = `<option value="all">All Teams</option>` + options;
        
        updateDashboardAndMarket();
    }

    function populatePlayerDropdown() {
        const options = players.map(p => `<option value="${String(p.PlayerName)}">${String(p.PlayerName)} (${p.TeamName})</option>`).join('');
        document.getElementById('perf-player-select').innerHTML = options;
    }

    // --- Sync Dashboard & Market ---
    function updateDashboardAndMarket() {
        updateDashboard();
        refreshMarket(); // Refreshing market forces button states to update based on active team
    }

    // --- Dashboard Math & Display ---
    function getTeamFinances(team) {
        let sponsor = 0;
        const tier = String(team.Tier || "").toLowerCase().trim();
        if (tier === "tier s") sponsor = 70000;
        else if (tier === "tier 1" || tier === "top 1") sponsor = 55000;
        else if (tier === "tier 2") sponsor = 40000;
        else if (tier === "tier 3") sponsor = 30000;

        const fixed = Number(team.Coach || 0) + Number(team.Analyst || 0) + 
                      Number(team.HealthTeam || 0) + Number(team.PhysicalTeam || 0) + 
                      Number(team.Maintenance || 0) + Number(team.Marketing || 0);
        
        const teamPlayers = players.filter(p => p.TeamName === team.TeamName);
        const salaries = teamPlayers.reduce((sum, p) => sum + ((p.MarketValue || 0) * 0.10), 0);
        
        return { sponsor, fixed, salaries, net: sponsor - (fixed + salaries) };
    }

    function updateDashboard() {
        const tName = document.getElementById('dash-team-select').value;
        const team = finances.find(t => t.TeamName === tName);
        if (!team) return;

        const { sponsor, fixed, salaries, net } = getTeamFinances(team);
        const netClass = net >= 0 ? 'text-green' : 'text-red';
        const netSign = net >= 0 ? '+' : '';

        document.getElementById('dash-content').innerHTML = `
            <div>
                <h3 style="margin-top:0;">üè¶ Current Bank: <span class="text-blue">$${Number(team.CurrentBank || 0).toLocaleString()}</span></h3>
                <div class="dash-row"><span>Tier Income (${team.Tier}):</span> <span class="text-green">+$${sponsor.toLocaleString()}</span></div>
                <div class="dash-row"><span>Fixed Costs (Excel):</span> <span class="text-red">-$${fixed.toLocaleString()}</span></div>
                <div class="dash-row"><span>Player Salaries (10% MV):</span> <span class="text-red">-$${salaries.toLocaleString()}</span></div>
                <div class="dash-row total"><span>Monthly Net Result:</span> <span class="${netClass}">${netSign}$${net.toLocaleString()}</span></div>
            </div>
            <div>
                <h3 style="margin-top:0;">üë• Roster Overview</h3>
                <div class="list-container" style="height: 120px; padding: 5px;">
                    ${players.filter(p => p.TeamName === tName).map(p => `
                        <div style="font-size: 0.85em; padding: 3px; border-bottom: 1px solid #222;">
                            <b>${String(p.PlayerName)}</b> (${p.Role}) | MV: $${p.MarketValue} | Sal: $${(p.MarketValue * 0.10).toFixed(0)}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // --- Core Logic ---
    function runMonthlyCycle() {
        saveState();
        finances.forEach(team => {
            const { net } = getTeamFinances(team);
            team.CurrentBank = (team.CurrentBank || 0) + net;
            addLog(`${team.TeamName} Month Cycle: Net Result ${net >= 0 ? '+' : ''}$${net.toFixed(2)}`);
        });

        players.forEach(p => { if (p.TeamName !== 'none' && p.ContractMonths > 0) p.ContractMonths -= 1; });
        addLog("Monthly Cycle completed. Contracts reduced by 1 month.");
        checkContracts(); refreshMarket(); updateDashboard();
    }

    function distributeTourneyPrize() {
        const amount = parseFloat(document.getElementById('prize-amount').value);
        const tName = document.getElementById('tourney-team-select').value;
        const team = finances.find(t => t.TeamName === tName);
        if (!amount || !team) return;

        saveState();
        team.CurrentBank += (amount * 0.6);
        const playerShare = (amount * 0.4) / 5;
        players.filter(p => p.TeamName === tName && p.Role === 'Starter').slice(0, 5).forEach(p => p.MarketValue += playerShare);
        
        addLog(`Tourney split: ${tName} Bank +$${(amount*0.6).toFixed(2)}. Starters MV +$${playerShare.toFixed(2)}.`);
        updateDashboard();
    }

    function applyIndividualPerformance() {
        const pName = document.getElementById('perf-player-select').value;
        const tier = document.getElementById('perf-tier').value;
        const type = document.getElementById('perf-type').value;
        const rates = { region: { mvp: 4000, evp: 3500, vp: 2500 }, global: { mvp: 10000, evp: 6000, vp: 4000 }, major: { mvp: 30000, evp: 12500, vp: 7500 } };
        const player = players.find(p => String(p.PlayerName) === pName);
        if (player) {
            saveState();
            const reward = rates[tier][type];
            player.Prestige = (player.Prestige || 0) + reward;
            addLog(`Performance Reward: ${pName} +$${reward} Prestige.`);
        }
    }

    // --- Market & Offers ---
    function refreshMarket() {
        const roleFilter = document.getElementById('market-filter').value;
        const teamFilter = document.getElementById('market-team-filter').value;
        const activeTeam = document.getElementById('dash-team-select').value; // O time que est√° "olhando" a loja
        const container = document.getElementById('market-list');
        container.innerHTML = '';
        
        players.filter(p => {
            const passRole = roleFilter === 'all' || (roleFilter === 'none' ? p.TeamName === 'none' : p.Role === roleFilter);
            const passTeam = teamFilter === 'all' || p.TeamName === teamFilter;
            return passRole && passTeam;
        }).forEach(p => {
            const standardBuyout = (p.MarketValue * 0.10 * (p.ContractMonths || 0) * 1.5);
            const playerNameStr = String(p.PlayerName);
            const isDiscounted = temporaryOffers[playerNameStr] !== undefined;
            const currentBuyout = isDiscounted ? temporaryOffers[playerNameStr] : standardBuyout;
            
            const div = document.createElement('div');
            div.className = 'item-card';
            
            let buttonsHtml = '';
            
            // L√≥gica: Se o Active Team √© o dono do jogador, ele n√£o pode "Comprar", ele pode fazer uma "Oferta"
            if (p.TeamName === activeTeam && p.TeamName !== 'none') {
                buttonsHtml = `<button onclick="makeOffer('${playerNameStr.replace(/'/g, "\\'")}', ${standardBuyout})" class="btn-purple">Make Offer</button>`;
            } else {
                buttonsHtml = `<button onclick="buyPlayer('${playerNameStr.replace(/'/g, "\\'")}', ${currentBuyout})" class="btn-blue">Buy</button>`;
            }

            div.innerHTML = `
                <span><b>${playerNameStr}</b> [${p.TeamName}] | MV: $${p.MarketValue} 
                    ${isDiscounted ? '<span class="discount-badge">ON SALE</span>' : ''}
                </span>
                <span>Buyout: $${p.TeamName === 'none' ? '0' : currentBuyout.toFixed(0)}</span>
                ${buttonsHtml}
            `;
            container.appendChild(div);
        });
    }

    function makeOffer(name, standardPrice) {
        const offer = prompt(`Set a discounted buyout price for ${name}.\nStandard Buyout is $${standardPrice.toFixed(2)}:`);
        if (offer !== null && !isNaN(offer) && offer >= 0) {
            temporaryOffers[name] = parseFloat(offer);
            addLog(`Discounted Offer created: ${name} is now available for $${parseFloat(offer).toFixed(2)}.`);
            refreshMarket();
        }
    }

    function buyPlayer(name, cost) {
        const buyerName = document.getElementById('dash-team-select').value; // Comprador √© sempre o Active Team
        const months = parseInt(document.getElementById('market-duration').value);
        const buyer = finances.find(t => t.TeamName === buyerName);
        const player = players.find(p => String(p.PlayerName) === name);
        if (!buyer || !player) return;

        const sellerName = player.TeamName;
        const finalCost = sellerName === 'none' ? 0 : cost;

        if (confirm(`Confirm purchase of ${name} for $${finalCost.toFixed(2)} with a new ${months} month contract?`)) {
            if (buyer.CurrentBank >= finalCost) {
                saveState();
                
                // Transfere o dinheiro
                buyer.CurrentBank -= finalCost;
                if (sellerName !== 'none') {
                    const seller = finances.find(t => t.TeamName === sellerName);
                    if (seller) seller.CurrentBank = (seller.CurrentBank || 0) + finalCost;
                }

                // Atualiza o jogador
                player.TeamName = buyerName;
                player.Role = 'Bench';
                player.ContractMonths = months;
                
                // Limpa ofertas tempor√°rias
                if(temporaryOffers[name]) delete temporaryOffers[name];

                let logMsg = `Transfer: ${name} to ${buyerName} (${months}m).`;
                if (sellerName !== 'none') logMsg += ` $${finalCost.toFixed(2)} paid to ${sellerName}.`;
                
                addLog(logMsg);
                refreshMarket(); checkContracts(); updateDashboard(); populatePlayerDropdown();
            } else { alert("Insufficient funds in Active Team Bank!"); }
        }
    }

    function checkContracts() {
        const container = document.getElementById('contract-alerts');
        container.innerHTML = '';
        players.filter(p => p.TeamName !== 'none' && p.ContractMonths <= 2).forEach(p => {
            const div = document.createElement('div');
            div.className = `item-card ${p.ContractMonths <= 0 ? 'expired' : 'warning'}`;
            div.innerHTML = `<span>${String(p.PlayerName)} (${p.TeamName}): ${p.ContractMonths}m left</span>
                             <button onclick="renewContract('${String(p.PlayerName).replace(/'/g, "\\'")}')">Renew</button>`;
            container.appendChild(div);
        });
    }

    function renewContract(name) {
        const p = players.find(p => String(p.PlayerName) === name);
        const team = finances.find(t => t.TeamName === p.TeamName);
        const months = parseInt(document.getElementById('renew-duration').value);
        if (p && team) {
            saveState();
            team.CurrentBank -= (p.MarketValue * 0.10);
            p.ContractMonths += months;
            addLog(`Renewed ${name} for ${months}m. Fee: 10% MV.`);
            checkContracts(); updateDashboard();
        }
    }

    // --- Helpers ---
    function saveState() {
        if (history.length >= 3) history.shift();
        history.push({ f: JSON.parse(JSON.stringify(finances)), p: JSON.parse(JSON.stringify(players)) });
    }

    function undo() {
        if (history.length > 0) {
            const last = history.pop();
            finances = last.f; players = last.p;
            addLog("Undo successful.");
            updateDashboardAndMarket(); checkContracts(); populatePlayerDropdown();
        }
    }

    function resetBankrupt() {
        const tName = document.getElementById('reset-team-select').value;
        const team = finances.find(t => t.TeamName === tName);
        if (team && confirm(`Set ${tName}'s bank to 0?`)) {
            saveState(); team.CurrentBank = 0;
            addLog(`Bank reset for ${tName}.`);
            updateDashboard();
        }
    }

    function applySeasonReset() {
        if(confirm("Apply -30% Market Value to all?")) {
            saveState(); players.forEach(p => p.MarketValue *= 0.7);
            addLog("Season Reset successful."); refreshMarket(); updateDashboard();
        }
    }

    function addLog(msg) {
        const l = document.getElementById('action-log');
        l.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>${l.innerHTML}`;
    }

    function exportExcels() {
        const wb1 = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb1, XLSX.utils.json_to_sheet(finances), "Finances");
        XLSX.writeFile(wb1, "finances_updated.xlsx");
        const wb2 = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb2, XLSX.utils.json_to_sheet(players), "Players");
        XLSX.writeFile(wb2, "players_updated.xlsx");
    }
</script>
</body>
</html>
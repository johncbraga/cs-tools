<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ultimate eSports Manager v4</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f0f0f; color: #f0f0f0; margin: 0; padding: 20px; }
        .container { max-width: 1300px; margin: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: 1 / -1; }
        .section { background: #1a1a1a; padding: 20px; border-radius: 10px; border: 1px solid #333; }
        h1, h2, h3 { color: #4caf50; margin-top: 0; }
        
        input, select { background: #2a2a2a; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 5px; margin: 5px 0; width: calc(100% - 22px); }
        button { cursor: pointer; padding: 10px 15px; border: none; border-radius: 5px; background: #4caf50; color: white; font-weight: bold; transition: 0.2s; margin-top: 5px; }
        button:hover { background: #45a049; }
        .btn-blue { background: #2196f3; } .btn-red { background: #f44336; } .btn-orange { background: #ff9800; }
        
        .list-container { height: 250px; overflow-y: auto; background: #111; padding: 10px; border-radius: 5px; border: 1px solid #333; }
        .item-card { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #222; font-size: 0.9em; }
        .log { background: #000; padding: 15px; height: 150px; overflow-y: auto; font-family: 'Courier New', monospace; color: #00ff00; border-radius: 5px; font-size: 12px; }
        .warning { color: #ff9800; } .expired { color: #f44336; font-weight: bold; }
        
        .tab-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .bank-info { color: #4caf50; font-weight: bold; font-size: 0.9em; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

<div class="container">
    <div class="section full-width">
        <h1>üéÆ Ultimate eSports Management System</h1>
        <div class="tab-grid">
            <div><label>Finances:</label><input type="file" id="upload-finances" accept=".xlsx"></div>
            <div><label>Players:</label><input type="file" id="upload-players" accept=".xlsx"></div>
        </div>
    </div>

    <div class="section">
        <h2>üèÜ Tournament & MVP</h2>
        <div class="tab-grid">
            <div>
                <h3>Tournament Win</h3>
                <select id="tourney-team-select"></select>
                <input type="number" id="prize-amount" placeholder="Total Prize ($)">
                <button onclick="distributeTourneyPrize()">Distribute (60% Team / 40% Starters)</button>
            </div>
            <div>
                <h3>Individual Performance</h3>
                <input type="text" id="perf-player-name" placeholder="Player Name">
                <select id="perf-tier">
                    <option value="region">Region (10k)</option>
                    <option value="global">Global (20k)</option>
                    <option value="major">Major (50k)</option>
                </select>
                <select id="perf-type">
                    <option value="mvp">MVP</option>
                    <option value="evp">EVP</option>
                    <option value="vp">VP</option>
                </select>
                <button onclick="applyIndividualPerformance()" class="btn-blue">Apply Reward</button>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>üõí Transfer Market</h2>
        <select id="market-filter" onchange="refreshMarket()">
            <option value="none">Free Agents (none)</option>
            <option value="Bench">Benched Players</option>
            <option value="Starter">Active Starters</option>
        </select>
        <label>Buying Team:</label>
        <span id="buying-team-bank" class="bank-info">Balance: $0.00</span>
        <select id="buying-team-select" onchange="updateBankDisplay()"></select>
        <div id="market-list" class="list-container"></div>
    </div>

    <div class="section">
        <h2>‚ö†Ô∏è Contract Alerts</h2>
        <div id="contract-alerts" class="list-container"></div>
    </div>

    <div class="section">
        <h2>‚öôÔ∏è Management Tools</h2>
        <div class="tab-grid">
            <div>
                <button onclick="runMonthlyCycle()" class="btn-blue" style="width: 100%; height: 50px;">RUN MONTHLY CYCLE</button>
            </div>
            <div>
                <select id="reset-team-select" title="Target for Reset"></select>
                <button onclick="resetBankrupt()" class="btn-red" style="width: 100%;">Reset Target Bankrupt (0 Bank)</button>
                <button onclick="applySeasonReset()" class="btn-orange" style="width: 100%; margin-top: 10px;">Season Reset (-30% MV)</button>
            </div>
        </div>
    </div>

    <div class="section full-width">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>üìã Activity Log</h3>
            <div>
                <button onclick="undo()" class="btn-red">Undo</button>
                <button onclick="exportExcels()" class="btn-blue">üì• Export Updated Excels</button>
            </div>
        </div>
        <div id="action-log" class="log">> Ready. Upload files to begin.</div>
    </div>
</div>

<script>
    let finances = [];
    let players = [];
    let history = [];

    // --- File Handling ---
    document.getElementById('upload-finances').addEventListener('change', (e) => handleExcel(e, d => {
        finances = d;
        populateTeamDropdowns();
        addLog("Finance file loaded.");
    }));

    document.getElementById('upload-players').addEventListener('change', (e) => handleExcel(e, d => {
        players = d;
        refreshMarket();
        checkContracts();
        addLog("Players file loaded.");
    }));

    function handleExcel(e, cb) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (evt) => {
            const wb = XLSX.read(evt.target.result, { type: 'binary' });
            cb(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
        };
        reader.readAsBinaryString(file);
    }

    function populateTeamDropdowns() {
        const options = finances.map(t => `<option value="${t.TeamName}">${t.TeamName}</option>`).join('');
        document.getElementById('tourney-team-select').innerHTML = options;
        document.getElementById('buying-team-select').innerHTML = options;
        document.getElementById('reset-team-select').innerHTML = options;
        updateBankDisplay();
    }

    function updateBankDisplay() {
        const tName = document.getElementById('buying-team-select').value;
        const team = finances.find(t => t.TeamName === tName);
        const display = document.getElementById('buying-team-bank');
        if (team) {
            display.innerText = `Balance: $${Number(team.CurrentBank).toLocaleString()}`;
        }
    }

    // --- Core Logic ---

    function runMonthlyCycle() {
        saveState();
        finances.forEach(team => {
            const teamPlayers = players.filter(p => p.TeamName === team.TeamName);
            const salaryTotal = teamPlayers.reduce((sum, p) => sum + (p.MarketValue * 0.10), 0);
            team.CurrentBank -= (salaryTotal + 20500);
        });
        players.forEach(p => { if (p.TeamName !== 'none' && p.ContractMonths > 0) p.ContractMonths -= 1; });
        addLog("Month Passed: Salaries/Fixed Costs deducted. Contracts -1 month.");
        checkContracts(); refreshMarket(); updateBankDisplay();
    }

    function distributeTourneyPrize() {
        const amount = parseFloat(document.getElementById('prize-amount').value);
        const tName = document.getElementById('tourney-team-select').value;
        const team = finances.find(t => t.TeamName === tName);
        if (!amount || !team) return;

        saveState();
        team.CurrentBank += (amount * 0.6);
        const playerShare = (amount * 0.4) / 5;
        let starters = players.filter(p => p.TeamName === tName && p.Role === 'Starter').slice(0, 5);
        starters.forEach(p => p.MarketValue += playerShare);
        
        addLog(`Prize Distributed (${tName}): +$${(amount*0.6).toFixed(2)} to Team. $${playerShare.toFixed(2)} to each of the 5 Starters.`);
        updateBankDisplay();
    }

    function applyIndividualPerformance() {
        const pName = document.getElementById('perf-player-name').value;
        const tier = document.getElementById('perf-tier').value;
        const type = document.getElementById('perf-type').value;
        const rates = {
            region: { mvp: 4000, evp: 3500, vp: 2500 },
            global: { mvp: 10000, evp: 6000, vp: 4000 },
            major: { mvp: 30000, evp: 12500, vp: 7500 }
        };
        const player = players.find(p => p.PlayerName === pName);
        if (player) {
            saveState();
            const reward = rates[tier][type];
            player.Prestige = (player.Prestige || 0) + reward;
            addLog(`Prestige Award: ${pName} +$${reward} for ${type} @ ${tier}`);
        }
    }

    // --- Market ---

    function refreshMarket() {
        const filter = document.getElementById('market-filter').value;
        const container = document.getElementById('market-list');
        container.innerHTML = '';
        players.filter(p => filter === 'none' ? p.TeamName === 'none' : p.Role === filter).forEach(p => {
            const buyout = (p.MarketValue * 0.10 * (p.ContractMonths || 0) * 1.5);
            const div = document.createElement('div');
            div.className = 'item-card';
            div.innerHTML = `
                <span><b>${p.PlayerName}</b> | MV: $${p.MarketValue}</span>
                <span>Buyout: $${p.TeamName === 'none' ? '0' : buyout.toFixed(0)}</span>
                <button onclick="buyPlayer('${p.PlayerName}', ${buyout})" class="btn-blue">Buy</button>
            `;
            container.appendChild(div);
        });
    }

    function buyPlayer(name, cost) {
        const buyerName = document.getElementById('buying-team-select').value;
        const buyer = finances.find(t => t.TeamName === buyerName);
        const player = players.find(p => p.PlayerName === name);
        if (!buyer || !player) return;

        const finalCost = player.TeamName === 'none' ? 0 : cost;
        
        if (confirm(`Confirm purchase of ${name} for $${finalCost.toFixed(2)}? (Player will move to Bench)`)) {
            if (buyer.CurrentBank >= finalCost) {
                saveState();
                buyer.CurrentBank -= finalCost;
                player.TeamName = buyerName;
                player.Role = 'Bench';
                player.ContractMonths = 12;
                addLog(`${name} joined ${buyerName} Bench. Cost: $${finalCost.toFixed(2)}`);
                refreshMarket(); checkContracts(); updateBankDisplay();
            } else { alert("Insufficient Team Bank!"); }
        }
    }

    function checkContracts() {
        const container = document.getElementById('contract-alerts');
        container.innerHTML = '';
        players.filter(p => p.TeamName !== 'none' && p.ContractMonths <= 2).forEach(p => {
            const div = document.createElement('div');
            div.className = `item-card ${p.ContractMonths <= 0 ? 'expired' : 'warning'}`;
            div.innerHTML = `<span>${p.PlayerName} (${p.TeamName}): ${p.ContractMonths}m left</span>
                             <button onclick="renewContract('${p.PlayerName}')">Renew 12m</button>`;
            container.appendChild(div);
        });
    }

    function renewContract(name) {
        const p = players.find(p => p.PlayerName === name);
        const team = finances.find(t => t.TeamName === p.TeamName);
        if (p && team) {
            saveState();
            team.CurrentBank -= (p.MarketValue * 0.10);
            p.ContractMonths += 12;
            addLog(`Renewed: ${name} (12m). Fee: 10% MV.`);
            checkContracts(); updateBankDisplay();
        }
    }

    // --- Helpers ---

    function saveState() {
        if (history.length >= 3) history.shift();
        history.push({ f: JSON.parse(JSON.stringify(finances)), p: JSON.parse(JSON.stringify(players)) });
    }

    function undo() {
        if (history.length > 0) {
            const last = history.pop();
            finances = last.f; players = last.p;
            addLog("Undo successful.");
            refreshMarket(); checkContracts(); updateBankDisplay();
        }
    }

    function resetBankrupt() {
        const tName = document.getElementById('reset-team-select').value;
        const team = finances.find(t => t.TeamName === tName);
        if (team && confirm(`Are you sure you want to reset ${tName}'s bank to 0?`)) {
            saveState(); team.CurrentBank = 0;
            addLog(`Bankrupt Reset applied to ${tName}.`);
            updateBankDisplay();
        }
    }

    function applySeasonReset() {
        if(confirm("Decrease all Market Values by 30%?")) {
            saveState(); players.forEach(p => p.MarketValue *= 0.7);
            addLog("Season Reset applied."); refreshMarket();
        }
    }

    function addLog(msg) {
        const l = document.getElementById('action-log');
        l.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>${l.innerHTML}`;
    }

    function exportExcels() {
        const wb1 = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb1, XLSX.utils.json_to_sheet(finances), "Finances");
        XLSX.writeFile(wb1, "finances_updated.xlsx");
        const wb2 = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb2, XLSX.utils.json_to_sheet(players), "Players");
        XLSX.writeFile(wb2, "players_updated.xlsx");
    }
</script>
</body>
</html>
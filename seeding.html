<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seeding • Match Generator</title>

  <style>
  :root{
    --bg:#0b1220;
    --card:#111a2e;
    --card2:#0f1730;
    --text:#e7ecff;
    --muted:#a9b3d6;
    --accent:#6ea8ff;
    --accent2:#7cf2c2;
    --danger:#ff6e6e;
    --border:rgba(231,236,255,.12);
    --shadow:0 10px 30px rgba(0,0,0,.35);
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    background:radial-gradient(1000px 700px at 20% -10%, rgba(110,168,255,.20), transparent 60%),
               radial-gradient(900px 650px at 90% 0%, rgba(124,242,194,.14), transparent 55%),
               var(--bg);
    color:var(--text);
  }
  .topbar{
    position:sticky; top:0;
    display:flex; align-items:flex-start; justify-content:space-between;
    gap:16px;
    padding:18px 22px;
    border-bottom:1px solid var(--border);
    backdrop-filter: blur(8px);
    background:rgba(11,18,32,.72);
    z-index:10;
  }
  .title h1{margin:0; font-size:20px; letter-spacing:.2px}
  .subtitle{margin:4px 0 0; color:var(--muted); font-size:13px}
  .back-btn{
    margin-left:auto;
    padding:10px 14px;
    border-radius:10px;
    border:1px solid var(--border);
    background:rgba(17,26,46,.7);
    color:var(--text);
    cursor:pointer;
    box-shadow:var(--shadow);
  }
  .back-btn:hover{border-color:rgba(110,168,255,.55)}
  .container{max-width:1150px; margin:18px auto 60px; padding:0 18px}
  .card{
    background:linear-gradient(180deg, rgba(17,26,46,.92), rgba(15,23,48,.92));
    border:1px solid var(--border);
    box-shadow:var(--shadow);
    border-radius:16px;
    padding:16px 16px 14px;
    margin:14px 0;
  }
  .state{padding:10px 12px; border-radius:12px; border:1px dashed var(--border); color:var(--muted)}
  .row{display:flex; align-items:center; gap:10px; margin-top:10px}
  .row.wrap{flex-wrap:wrap}
  .field{display:flex; flex-direction:column; gap:6px; min-width:230px}
  .field.grow{flex:1; min-width:280px}
  label{font-size:12px; color:var(--muted)}
  input, textarea{
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    background:rgba(8,13,25,.6);
    color:var(--text);
    outline:none;
  }
  textarea{min-height:86px; resize:vertical; font-family:inherit}
  input:focus, textarea:focus{border-color:rgba(110,168,255,.75)}
  .btn{
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    background:rgba(8,13,25,.6);
    color:var(--text);
    cursor:pointer;
  }
  .btn:hover{border-color:rgba(110,168,255,.55)}
  .btn.primary{background:linear-gradient(135deg, rgba(110,168,255,.35), rgba(124,242,194,.18)); border-color:rgba(110,168,255,.55)}
  .btn.secondary{background:rgba(255,255,255,.04)}
  .btn:disabled{opacity:.55; cursor:not-allowed}
  .muted{color:var(--muted); font-size:13px}
  .hint{color:var(--muted); font-size:12px; line-height:1.25}
  .list-wrap{margin-top:12px}
  .list-head{display:flex; justify-content:space-between; align-items:center; padding:8px 10px; border:1px solid var(--border); border-radius:12px 12px 0 0; background:rgba(8,13,25,.45)}
  .team-list{
    max-height:340px;
    overflow:auto;
    border:1px solid var(--border);
    border-top:none;
    border-radius:0 0 12px 12px;
    padding:10px;
    background:rgba(8,13,25,.35);
  }
  .team-item{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 8px; border-radius:10px}
  .team-item:hover{background:rgba(255,255,255,.04)}
  .team-left{display:flex; align-items:center; gap:10px}
  .badge{font-family:var(--mono); font-size:12px; color:var(--muted)}
  .mono{font-family:var(--mono); font-size:13px; white-space:pre-wrap}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px}
  @media (max-width: 980px){.grid{grid-template-columns:1fr}}
  .matchups{display:flex; flex-direction:column; gap:10px}
  .match{
    border:1px solid var(--border);
    border-radius:14px;
    padding:10px 12px;
    background:rgba(8,13,25,.35);
  }
  .match .hdr{display:flex; justify-content:space-between; align-items:center; gap:12px}
  .match .round{color:var(--muted); font-size:12px}
  .pair{display:grid; grid-template-columns:1fr auto 1fr; gap:10px; align-items:center; margin-top:8px}
  .team{
    padding:8px 10px;
    border:1px solid var(--border);
    border-radius:12px;
    background:rgba(255,255,255,.03);
  }
  .team strong{display:block; font-weight:650}
  .team small{color:var(--muted); font-family:var(--mono)}
  .vs{color:var(--accent); font-weight:700}
  .bye{border-color:rgba(124,242,194,.35)}
  .footer{max-width:1150px; margin:18px auto; padding:0 18px 30px;}
  kbd{border:1px solid var(--border); border-bottom-color:rgba(255,255,255,.25); padding:2px 6px; border-radius:8px; background:rgba(8,13,25,.55); font-family:var(--mono)}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="title">
      <h1>Match Generator (Seeding)</h1>
      <p class="subtitle">Strongest vs weakest seeding — match order is randomized.</p>
    </div>

    <button id="backBtn" class="back-btn" title="Go back to index.html (shortcut: key 0)">
      ⟵ Back
    </button>
  </header>

  <main class="container">

    <section class="card">
      <h2>1) Ranking source</h2>
      <p>
        This page reads <code>file/ranking.xlsx</code> and uses only the <strong>Team</strong> and <strong>Points</strong> columns.
      </p>

      <div id="loadState" class="state">Loading ranking…</div>

      <details class="fallback" id="fallbackBox">
        <summary>Can't read the Excel? Paste data manually (Team, Points)</summary>
        <p class="hint">Format: <code>Team Name;Points</code> (one per line) — separator “;” or “,”.</p>
        <textarea id="manualInput" placeholder="Example:
Team A;105
Team B;90
Team C;60"></textarea>
        <div class="row">
          <button id="useManual" class="btn">Use pasted data</button>
          <span id="manualStatus" class="muted"></span>
        </div>
      </details>
    </section>

    <section class="card">
      <h2>2) Pick the teams</h2>

      <div class="row wrap">
        <div class="field">
          <label for="filter">Search teams</label>
          <input id="filter" type="text" placeholder="Type to filter…" autocomplete="off" />
        </div>
      </div>

      <div class="row wrap">
        <div class="field grow">
          <label for="bulkNames">Paste a list of team names (optional)</label>
          <textarea id="bulkNames" placeholder="Paste names (one per line) to auto-select…"></textarea>
          <div class="row">
            <button id="applyBulk" class="btn">Select pasted names</button>
            <button id="clearSel" class="btn secondary">Clear selection</button>
            <span class="muted" id="selCount"></span>
          </div>
        </div>
      </div>

      <div class="list-wrap">
        <div class="list-head">
          <span>Teams in ranking</span>
          <span class="muted">Check the ones that will play</span>
        </div>
        <div id="teamList" class="team-list"></div>
      </div>

    </section>

    <section class="card">
      <h2>3) Matches</h2>
      <p class="hint">
        Seeding pairs the strongest with the weakest (<strong>#1 vs last</strong>, <strong>#2 vs second-to-last</strong>, etc.).
        The displayed match order is then <strong>shuffled randomly</strong>.
        Odd team count creates a <strong>BYE</strong>.
      </p>

      <div class="row wrap">
        <button id="generate" class="btn primary">Generate matches</button>
        <button id="copy" class="btn" disabled>Copy</button>
        <button id="download" class="btn" disabled>Download .txt</button>
        <span id="genInfo" class="muted"></span>
      </div>

      <div class="grid">
        <div>
          <h3>Selected (sorted by points)</h3>
          <div id="selectedTable" class="mono"></div>
        </div>
        <div>
          <h3>Matches (random order)</h3>
          <div id="matchups" class="matchups"></div>
        </div>
      </div>

    </section>

  </main>

  <footer class="footer">
    <span class="muted">Shortcut: press <kbd>0</kbd> (outside inputs) to go back to <code>index.html</code>.</span>
  </footer>

  <!-- SheetJS (xlsx) to read ranking.xlsx in the browser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
  const RANKING_PATH = 'file/ranking.xlsx';

  const els = {
    loadState: document.getElementById('loadState'),
    fallbackBox: document.getElementById('fallbackBox'),
    manualInput: document.getElementById('manualInput'),
    useManual: document.getElementById('useManual'),
    manualStatus: document.getElementById('manualStatus'),

    filter: document.getElementById('filter'),

    bulkNames: document.getElementById('bulkNames'),
    applyBulk: document.getElementById('applyBulk'),
    clearSel: document.getElementById('clearSel'),
    selCount: document.getElementById('selCount'),

    teamList: document.getElementById('teamList'),
    generate: document.getElementById('generate'),
    copy: document.getElementById('copy'),
    download: document.getElementById('download'),
    genInfo: document.getElementById('genInfo'),

    selectedTable: document.getElementById('selectedTable'),
    matchups: document.getElementById('matchups'),

    backBtn: document.getElementById('backBtn'),
  };

  let ranking = [];           // [{team, points, seed}]
  let selected = new Set();   // team names
  let lastOutputText = '';

  function normalizeStr(s){
    return (s ?? '').toString().trim();
  }

  function parseNumber(v){
    if (typeof v === 'number') return v;
    if (v === null || v === undefined) return 0;
    const s = v.toString().replace(/\s/g,'').replace(',','.');
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function sortRanking(arr){
    return arr.slice().sort((a,b)=>{
      if (b.points !== a.points) return b.points - a.points;
      return a.team.localeCompare(b.team, 'en', {sensitivity:'base'});
    });
  }

  function isTypingTarget(el){
    if (!el) return false;
    const tag = (el.tagName || '').toLowerCase();
    return tag === 'input' || tag === 'textarea' || el.isContentEditable;
  }

  function goBack(){
    window.location.href = 'index.html';
  }

  function escapeHtml(str){
    return (str || '').replace(/[&<>"']/g, (m)=>({
      '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#039;'
    }[m]));
  }

  function updateSelCount(){
    els.selCount.textContent = `${selected.size} selected`;
  }

  function renderTeamList(){
    const f = normalizeStr(els.filter.value).toLowerCase();
    const frag = document.createDocumentFragment();
    let visible = 0;

    for (const row of ranking){
      const name = row.team;
      if (f && !name.toLowerCase().includes(f)) continue;
      visible++;

      const item = document.createElement('div');
      item.className = 'team-item';

      const left = document.createElement('div');
      left.className = 'team-left';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = selected.has(name);
      cb.addEventListener('change', ()=>{
        if (cb.checked) selected.add(name); else selected.delete(name);
        updateSelCount();
      });

      const label = document.createElement('div');
      label.innerHTML = `<strong>${escapeHtml(name)}</strong><div class="badge">Points: ${row.points}</div>`;

      left.appendChild(cb);
      left.appendChild(label);

      const right = document.createElement('div');
      right.className = 'badge';
      right.textContent = `#${row.seed}`;

      item.appendChild(left);
      item.appendChild(right);
      frag.appendChild(item);
    }

    els.teamList.innerHTML = '';
    els.teamList.appendChild(frag);
    if (visible === 0){
      els.teamList.innerHTML = `<div class="muted" style="padding:10px">No teams found for this filter.</div>`;
    }
  }

  function parseManualLines(text){
    const lines = (text || '').split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const out = [];
    for (const line of lines){
      const parts = line.includes(';') ? line.split(';') : line.split(',');
      if (parts.length < 2) continue;
      const team = normalizeStr(parts[0]);
      const points = parseNumber(parts.slice(1).join('.'));
      if (team) out.push({team, points});
    }
    return out;
  }

  function applyBulkNames(){
    const names = (els.bulkNames.value || '').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const setLower = new Set(names.map(n=>n.toLowerCase()));
    let matched = 0;
    for (const row of ranking){
      if (setLower.has(row.team.toLowerCase())){
        if (!selected.has(row.team)){
          selected.add(row.team);
          matched++;
        }
      }
    }
    updateSelCount();
    renderTeamList();
    els.genInfo.textContent = matched ? `Selected ${matched} matching name(s).` : 'No pasted name matched the ranking (check spelling).';
  }

  function clearSelection(){
    selected.clear();
    updateSelCount();
    renderTeamList();
    els.genInfo.textContent = '';
  }

  function getSelectedTeamsSorted(){
    const chosen = ranking.filter(r => selected.has(r.team));
    return sortRanking(chosen);
  }

  function renderSelectedTable(teams){
    let txt = '';
    teams.forEach((t,i)=>{
      txt += `${String(i+1).padStart(2,'0')}  ${t.team}  —  ${t.points}\n`;
    });
    els.selectedTable.textContent = txt || '—';
  }

  function renderTeamBox(seed, t){
    const box = document.createElement('div');
    box.className = 'team' + (t ? '' : ' bye');
    if (t){
      box.innerHTML = `<strong>#${seed} ${escapeHtml(t.team)}</strong><small>${t.points} pts</small>`;
    } else {
      box.innerHTML = `<strong>#${seed} BYE</strong><small>no opponent</small>`;
    }
    return box;
  }

  function renderMatches(matches){
    els.matchups.innerHTML = '';
    if (!matches.length){
      els.matchups.innerHTML = '<div class="muted">No matches to show.</div>';
      return;
    }

    const frag = document.createDocumentFragment();
    matches.forEach((m, idx)=>{
      const div = document.createElement('div');
      div.className = 'match';

      const hdr = document.createElement('div');
      hdr.className = 'hdr';
      hdr.innerHTML = `<div><strong>Match ${idx+1}</strong></div><div class="round">Randomized order</div>`;

      const pair = document.createElement('div');
      pair.className = 'pair';

      pair.appendChild(renderTeamBox(m.aSeed, m.a));
      const vs = document.createElement('div');
      vs.className = 'vs';
      vs.textContent = 'VS';
      pair.appendChild(vs);
      pair.appendChild(renderTeamBox(m.bSeed, m.b));

      div.appendChild(hdr);
      div.appendChild(pair);
      frag.appendChild(div);
    });

    els.matchups.appendChild(frag);
  }

  function buildSeededPairs(teams){
    const n = teams.length;
    const matches = [];
    for (let i=0; i<Math.ceil(n/2); i++){
      const a = teams[i];
      const bIndex = n - 1 - i;
      const b = (bIndex > i) ? teams[bIndex] : null;
      matches.push({
        aSeed: i+1,
        bSeed: b ? (bIndex+1) : (bIndex+1),
        a,
        b
      });
    }
    return matches;
  }

  function shuffleInPlace(arr){
    for (let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function buildOutputText(teams, matches){
    const lines = [];
    lines.push(`Generated matches (seeded strong vs weak, randomized order) — selected teams: ${teams.length}`);
    lines.push('');
    matches.forEach((m, idx)=>{
      const a = m.a ? `${m.a.team} (${m.a.points})` : 'BYE';
      const b = m.b ? `${m.b.team} (${m.b.points})` : 'BYE';
      lines.push(`Match ${idx+1}: #${m.aSeed} ${a}  vs  #${m.bSeed} ${b}`);
    });
    return lines.join('\n');
  }

  function copyToClipboard(text){
    return navigator.clipboard.writeText(text);
  }

  function downloadText(filename, text){
    const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{
      URL.revokeObjectURL(a.href);
      a.remove();
    }, 0);
  }

  function generate(){
    const teams = getSelectedTeamsSorted();
    if (teams.length < 2){
      els.genInfo.textContent = 'Select at least 2 teams.';
      return;
    }

    const seededPairs = buildSeededPairs(teams);
    const matches = shuffleInPlace(seededPairs.slice());

    renderSelectedTable(teams);
    renderMatches(matches);

    lastOutputText = buildOutputText(teams, matches);
    els.copy.disabled = false;
    els.download.disabled = false;

    const byeCount = teams.length % 2 === 1 ? 1 : 0;
    els.genInfo.textContent = `Generated: ${matches.length} match(es)` + (byeCount ? ' (1 BYE).' : '.');
  }

  function findColumnKey(obj, wanted){
    const keys = Object.keys(obj);
    const lower = wanted.toLowerCase();
    for (const k of keys){
      if (k.toLowerCase() === lower) return k;
    }
    for (const k of keys){
      if (k.toLowerCase().includes(lower)) return k;
    }
    return null;
  }

  async function loadRankingFromXlsx(){
    if (!window.XLSX) throw new Error('XLSX library did not load.');

    const res = await fetch(RANKING_PATH, {cache:'no-store'});
    if (!res.ok) throw new Error(`Could not fetch ${RANKING_PATH} (HTTP ${res.status}).`);
    const buf = await res.arrayBuffer();

    const wb = XLSX.read(buf, {type:'array'});
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws, {defval:''});
    if (!rows.length) throw new Error('Empty sheet.');

    const teamKey = findColumnKey(rows[0], 'Team');
    const pointsKey = findColumnKey(rows[0], 'Points');
    if (!teamKey || !pointsKey){
      throw new Error('Could not find Team and Points columns.');
    }

    const data = [];
    for (const r of rows){
      const team = normalizeStr(r[teamKey]);
      if (!team) continue;
      const points = parseNumber(r[pointsKey]);
      data.push({team, points});
    }

    const sorted = sortRanking(data);
    sorted.forEach((t,i)=> t.seed = i+1);
    return sorted;
  }

  function setLoadedState(ok, msg){
    els.loadState.textContent = msg;
    els.loadState.style.borderColor = ok ? 'rgba(124,242,194,.35)' : 'rgba(255,110,110,.45)';
    els.loadState.style.color = ok ? 'var(--muted)' : 'var(--danger)';
  }

  async function init(){
    els.backBtn.addEventListener('click', goBack);
    document.addEventListener('keydown', (e)=>{
      if (e.key === '0' && !isTypingTarget(document.activeElement)){
        e.preventDefault();
        goBack();
      }
    });

    els.filter.addEventListener('input', renderTeamList);
    els.applyBulk.addEventListener('click', applyBulkNames);
    els.clearSel.addEventListener('click', clearSelection);
    els.generate.addEventListener('click', generate);

    els.copy.addEventListener('click', async ()=>{
      try{
        await copyToClipboard(lastOutputText);
        els.genInfo.textContent = 'Copied!';
      } catch {
        els.genInfo.textContent = 'Could not copy automatically. Select and copy manually.';
      }
    });

    els.download.addEventListener('click', ()=>{
      downloadText('matches.txt', lastOutputText || '');
    });

    els.useManual.addEventListener('click', ()=>{
      const data = parseManualLines(els.manualInput.value);
      if (data.length < 2){
        els.manualStatus.textContent = 'Paste at least 2 valid lines.';
        return;
      }
      ranking = sortRanking(data).map((t,i)=>({ ...t, seed:i+1 }));
      setLoadedState(true, `Using pasted data (${ranking.length} teams).`);
      els.manualStatus.textContent = `OK — ${ranking.length} loaded.`;
      renderTeamList();
    });

    try{
      ranking = await loadRankingFromXlsx();
      setLoadedState(true, `Ranking loaded: ${ranking.length} teams (from ${RANKING_PATH}).`);
      els.fallbackBox.open = false;
    } catch (err){
      console.warn(err);
      setLoadedState(false, `Failed to read ${RANKING_PATH}. Open the section below and paste manually, or use a local server.`);
      els.fallbackBox.open = true;
    }

    updateSelCount();
    renderTeamList();
  }

  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>